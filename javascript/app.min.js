(function(p){var f=function(){throw"Synchronous require() is not supported.";};f.unit={};var m="",j,k,q,r=2E4,n,y=this.importScripts!==void 0,D=!y&&document.getElementsByTagName("head")[0],l=Object.prototype.hasOwnProperty;if(function(){for(var a in{hasOwnProperty:!0})return a}()=="hasOwnProperty")var s=function(a,b,d){for(var c in a)l.call(a,c)&&b.call(d,c)};else var z=["isPrototypeOf","hasOwnProperty","toLocaleString","toString","valueOf"],s=function(a,b,d){for(var c in a)l.call(a,c)&&b.call(d,
c);for(var e=z.length;e--;)c=z[e],l.call(a,c)&&b.call(d,c)};var E=function(a,b){for(var d=0;d<a.length;)b.call(null,a[d],d)===!0?a.splice(d,1):d++},A=function(a,b){var d=a.split("/"),b=b||"";b.length&&b.charAt(b.length-1)!="/"&&(b+="/");var c=b.split("/");c.pop();for(var e;e=d.shift();)e!="."&&(e==".."&&c.length&&c[c.length-1]!=".."?c.pop():c.push(e));return c.join("/")},o=f.unit.resolveModuleId=function(a,b){return a.charAt(0)!="."?a:A(a,b)},t=function(a){return a.charAt(0)!="."?m+a+".js":this._resolveModuleId(a,
m)+".js"},i=function(a){if(!l.call(j,a))return null;return j[a]},F=function(a,b){k.push([a.slice(0),b])},C=function(a,b,d){for(var c=[],e=a.length;e--;){var h=o(a[e],d);i(h);u(h)||c.push(h)}c.length?(F(c,function(){b(v(d))}),B(c)):setTimeout(function(){b(v(d))},0)},v=function(a){var b=function(b){var c=o(b,a);if(b=i(c)){if(b.error)throw"Error loading module";}else throw"Module not loaded";if(!b.exports){b.exports={};for(var c=c.substring(0,c.lastIndexOf("/")+1),e=b.injects,h=[],g=0,w=e.length;g<w;g++)e[g]==
"require"?h.push(v(c)):e[g]=="exports"?h.push(b.exports):e[g]=="module"&&h.push(b.module);b.factory.apply(null,h)}return b.exports};b.ensure=function(b,c){C(b,c,a)};if(n!=null)b.main=i(n).module;return b},B=function(a){for(var b=a.length;b--;){var d=a[b];i(d)==null&&(j[d]={},q(d))}},u=function(a){var b={},d=function(a){if(b[a]==!0)return!0;b[a]=!0;a=i(a);if(!a||!a.defined)return!1;else{for(var a=a.deps||[],e=a.length;e--;)if(!d(a[e]))return!1;return!0}};return d(a)},x=function(){for(var a=0;a<k.length;){for(var b=
k[a][0],d=k[a][1],c=0;c<b.length;)u(b[c])?b.splice(c,1):c++;b.length?a++:(k.splice(a,1),d!=null&&setTimeout(d,0))}};q=function(a){var b,d=function(){var b=i(a);if(!b.defined)b.defined=b.error=!0,x()},c=this.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),e=t(a);c.open("GET",e,!0);c.onreadystatechange=function(){if(c.readyState===4)if(clearTimeout(b),c.status==200||c.status===0){for(var h=c.responseText,g=G(h),w=a.substring(0,a.lastIndexOf("/")+1),i={},k=g.length;k--;)g[k]=
o(g[k],w);try{i[a]=p("\r\n"+h+"\r\n")}catch(j){throw j instanceof SyntaxError&&(h="Syntax Error: ",j.lineNumber?h+="line "+(j.lineNumber-581):console.log("GameJs tip: use Firefox to see line numbers in Syntax Errors."),h+=" in file "+e,console.log(h)),j;}f.define(i,g)}else d()};b=setTimeout(d,r);c.send(null)};var G=f.unit.determineShallowDependencies=function(a){for(var b={},d,c=/(?:^|[^\w\$_.])require\s*\(\s*("[^"\\]*(?:\\.[^"\\]*)*"|'[^'\\]*(?:\\.[^'\\]*)*')\s*\)/g;d=c.exec(a);)d=eval(d[1]),l.call(b,
d)||(b[d]=!0);for(c=/(?:^|[^\w\$_.])require.ensure\s*\(\s*(\[("[^"\\]*(?:\\.[^"\\]*)*"|'[^'\\]*(?:\\.[^'\\]*)*'|\s*|,)*\])/g;d=c.exec(a);)for(var e=eval(d[1]),h=e.length;h--;)d=e[h],delete b[d];var g=[];s(b,function(a){g.push(a)});return g},H=function(a){var b=document.createElement("script");b.type="text/javascript";b.src=t(a);var d=!!b.addEventListener,c,e=function(){g(!1)},h=function(){(d||b.readyState=="complete"||b.readyState=="loaded")&&g(i(a).defined)},g=function(g){clearTimeout(c);d?(b.removeEventListener("load",
h,!1),b.removeEventListener("error",e,!1)):b.detachEvent("onreadystatechange",h);if(!g&&(g=i(a),!g.defined))g.defined=g.error=!0,x()};d?(b.addEventListener("load",h,!1),b.addEventListener("error",e,!1)):b.attachEvent("onreadystatechange",h);c=setTimeout(e,r);D.appendChild(b)},I=function(a,b,d){var c={modules:[]},e=["require","exports","module"];typeof a=="object"?(c.deps=b||[],s(a,function(b){var d={id:b};typeof a[b]=="function"?(d.factory=a[b],d.injects=e):(d.factory=a[b].factory,d.injects=a[b].injects||
e);c.modules.push(d)})):(c.deps=b.slice(0),E(c.deps,function(a){a:{for(var b=e.length;b--;)if(e[b]==a){a=b;break a}a=-1}return a>=0}),c.modules.push({id:a,factory:d,injects:b}));return c};f.setModuleRoot=function(a){if(this.window&&!/^http(s?):\/\//.test(a))var b=window.location.href,b=b.substr(0,b.lastIndexOf("/")+1),a=A(a,b);a.length&&a.charAt(a.length-1)!="/"&&(a+="/");m=a};f.getModuleRoot=function(){return m};f.setTimeoutLength=function(a){r=a};f.useScriptTags=function(){q=H};f.def=f.define=function(){for(var a=
I.apply(null,arguments),b=[],d=[],c=a.deps,e=a.modules.length;e--;){var h=a.modules[e],g=h.id,f=i(g);f||(f=j[g]={});f.module={id:g,uri:t(g)};f.defined=!0;f.deps=c.slice(0);f.injects=h.injects;f.factory=h.factory;d.push(f)}for(e=c.length;e--;)g=c[e],f=i(g),(!f||!u(g))&&b.push(g);b.length&&setTimeout(function(){B(b)},0);x()};f.isKnown=function(a){return i(a)!=null};f.isDefined=function(a){a=i(a);return!(!a||!a.defined)};f.ensure=function(a,b){C(a,b,"")};f.run=function(a,b){a=n=o(a,"");f.ensure([a],
function(d){d(a);b!=null&&b()})};f.reset=function(){n=null;j={};k=[];f.define({system:function(){}})};f.reset();y?self.require=f:window.require=f})(function(p){with(this.importScripts?self:window)return new Function("require","exports","module",p)});
require.define({prng:function(f,b){var d=f("./prng/alea").Alea,c=null,k=b.random=function(){return c()};b.rand=function(c,a){return c+k()*(a-c)};(b.init=function(g){c=new d(g||Date.now())})()}},["prng/alea"]);
require.define({main:function(f){var b=f("gamejs"),d=f("./scenes"),c=f("./director").Director,k=f("./sounds"),g=f("./world"),a=["./images/terrain/dirt.png","./images/terrain/gras.png","./images/terrain/hills.png","./images/terrain/mountains.png","./images/terrain/sand.png","./images/terrain/sandwoods.png","./images/terrain/woods.png","./images/terrain/water.png","./images/terrain/bricks.png","./images/terrain/extras.png","./images/terrain/crater.png","./images/muzzle.png","./images/bomb.png","./images/explosion.png",
"./images/fireball.png","./images/lightcone.png","./images/units/captain.png","./images/units/pirate.png","./images/units/cultist.png","./images/units/blobs.png","./images/units/fire.png","./images/units/wind.png","./images/units/skull.png","./images/coins.png","./images/shield.png","./images/coin.png","./images/bomb_big.png","./images/blood.png","./images/blueglow.png","./images/arrow.png"].concat(k.getPreloadAssets());window.DEBUG=!1;b.preload(a);b.ready(function(){var a=window.DISPLAY_DIMS=[Math.min(window.innerWidth-
50,1800),Math.min(window.innerHeight-50,900)],j=document.getElementById("gjs-loader");j.style.display="block";var e=document.getElementById("km-loading"),n=b.display.setMode(a,b.display.FULLSCREEN);b.setLogLevel(0);b.display.setCaption("Kingmaker [alpha]");k.init();var m=new c;b.onTick(function(a){m.update(a);m.draw(n)});b.onEvent(function(a){a.type!==b.event.MOUSE_MOTION&&(a.type===b.event.DISPLAY_FULLSCREEN_ENABLED&&(n=b.display.setMode([window.innerWidth-20,window.innerHeight-20],b.display.FULLSCREEN)),
m.handle(a))});a=new b.worker.Worker("./workers/chunk");a.onEvent(function(a){a=g.Chunk.load(a.chunk);a=new d.Game(a);m.start(a);e.style.display="none";p.style.display="block";b.log("starting director")});a.post();var o=document.getElementById("gjs-canvas");o.style.display="none";var p=document.getElementById("km-play");p.style.display="none";p.addEventListener("mouseup",function(){o.style.display="block";j.style.display="none";$("#coordx").text((Date.now()+"").substring(10,13));$("#coordy").text((Date.now()+
"").substring(5,8));f("./stats");m.setOnAir()},!1)});$(document).ready(function(){var a=1,j=$("#tutorialbox"),e=function(){j.popover("destroy")},c=function(){var c=$(".km-helpquad:nth-child("+a+")").html();c||(a=0);$("#tutorialbox").popover({content:c,trigger:"manual",placement:"top",html:!0,animation:!0}).popover("show");setTimeout(e,25E3);j.off("click").on("click",e);a++};$("#km-play").on("click",function(){setInterval(c,3E4);c()})})}},["gamejs","scenes","director","sounds","world","stats"]);
require.define({"gamejs/draw":function(f,b){b.line=function(d,c,k,g,a){d=d.context;d.save();d.beginPath();d.strokeStyle=c;d.lineWidth=a||1;d.moveTo(k[0],k[1]);d.lineTo(g[0],g[1]);d.stroke();d.restore()};b.lines=function(d,c,k,g,a){var k=k||!1,l=d.context;l.save();l.beginPath();l.strokeStyle=l.fillStyle=c;l.lineWidth=a||1;g.forEach(function(a,e){e===0?l.moveTo(a[0],a[1]):l.lineTo(a[0],a[1])});k&&l.lineTo(g[0][0],g[0][1]);l.stroke();l.restore()};b.circle=function(d,c,k,g,a){if(!g)throw Error("[circle] radius required argument");
if(!k||!(k instanceof Array))throw Error("[circle] pos must be given & array"+k);d=d.context;d.save();d.beginPath();d.strokeStyle=d.fillStyle=c;d.lineWidth=a||1;d.arc(k[0],k[1],g,0,2*Math.PI,!0);a===void 0||a===0?d.fill():d.stroke();d.restore()};b.rect=function(d,c,k,g){d=d.context;d.save();d.beginPath();d.strokeStyle=d.fillStyle=c;isNaN(g)||g===0?d.fillRect(k.left,k.top,k.width,k.height):(d.lineWidth=g||1,d.strokeRect(k.left,k.top,k.width,k.height));d.restore()};b.arc=function(d,c,k,g,a,l){d=d.context;
d.save();d.beginPath();d.strokeStyle=d.fillStyle=c;d.arc(k.center[0],k.center[1],k.width/2,g*(Math.PI/180),a*(Math.PI/180),!1);isNaN(l)||l===0?d.fill():(d.lineWidth=l||1,d.stroke());d.restore()};b.polygon=function(d,c,k,g){var a=d.context;a.save();a.fillStyle=a.strokeStyle=c;a.beginPath();k.forEach(function(l,j){j==0?a.moveTo(l[0],l[1]):a.lineTo(l[0],l[1])});a.closePath();isNaN(g)||g===0?a.fill():(a.lineWidth=g||1,a.stroke());a.restore()};b.quadraticCurve=function(d,c,k,g,a,l){if(!k||!(k instanceof
Array))throw Error("[quadratic_curve] startPos must be defined!");if(!g||!(g instanceof Array))throw Error("[quadratic_curve] endPos must be defined!");if(!a||!(a instanceof Array))throw Error("[quadratic_curve] controlPos must be defined!");d=d.context;d.save();d.fillStyle=d.strokeStyle=c;d.lineWidth=l||1;d.beginPath();d.moveTo(k[0],k[1]);d.quadraticCurveTo(a[0],a[1],g[0],g[1]);d.stroke();d.restore()};b.bezierCurve=function(d,c,k,g,a,l,j){if(!k||!(k instanceof Array))throw Error("[bezier_curve] startPos must be defined!");
if(!g||!(g instanceof Array))throw Error("[bezier_curve] endPos must be defined!");if(!a||!(a instanceof Array))throw Error("[bezier_curve] ct1Pos must be defined!");if(!l||!(l instanceof Array))throw Error("[bezier_curve] ct2Pos must be defined!");d=d.context;d.save();d.fillStyle=d.strokeStyle=c;d.lineWidth=j||1;d.beginPath();d.moveTo(k[0],k[1]);d.bezierCurveTo(a[0],a[1],l[0],l[1],g[0],g[1]);d.stroke();d.restore()}}},[]);
require.define({"gamejs/transform":function(f,b){var d=f("../gamejs").Surface,c=f("./utils/matrix");f("./utils/math");var k=f("./utils/vectors");b.rotate=function(g,a){var l=g.getSize(),j=a*Math.PI/180,e=l;if(a%360!==0)var e=g.getRect(),e=[[-e.width/2,e.height/2],[e.width/2,e.height/2],[-e.width/2,-e.height/2],[e.width/2,-e.height/2]].map(function(a){return k.rotate(a,j)}),b=e.map(function(a){return a[0]}),m=e.map(function(a){return a[1]}),e=Math.min.apply(Math,b),b=Math.max.apply(Math,b),f=Math.min.apply(Math,
m),m=Math.max.apply(Math,m),e=[b-e,m-f];m=new d(e);b=g._matrix;g._matrix=c.translate(g._matrix,l[0]/2,l[1]/2);g._matrix=c.rotate(g._matrix,j);g._matrix=c.translate(g._matrix,-l[0]/2,-l[1]/2);m.blit(g,[(e[0]-l[0])/2,(e[1]-l[1])/2]);g._matrix=b;return m};b.scale=function(g,a){var l=a[0],j=a[1];if(l<=0||j<=0)throw Error("[gamejs.transform.scale] Invalid arguments for height and width",[l,j]);var e=g.getSize(),k=l/e[0],e=j/e[1],l=new d([l,j]),j=g._matrix.slice(0);g._matrix=c.scale(g._matrix,[k,e]);l.blit(g);
g._matrix=j;return l};b.flip=function(c,a,l){var j=c.getSize(),e=new d(j),k=1,b=1,f=0,p=0;a===!0&&(k=-1,f=-j[0]);l===!0&&(b=-1,p=-j[1]);e.context.save();e.context.scale(k,b);e.context.drawImage(c.canvas,f,p);e.context.restore();return e}}},["gamejs","gamejs/utils/matrix","gamejs/utils/math","gamejs/utils/vectors"]);
require.define({"gamejs/display":function(f,b){var d=f("../gamejs").Surface,c=null,k=b.DISABLE_SMOOTHING=2,g=b.FULLSCREEN=4,a=b.POINTERLOCK=8,l=0,j=function(){var a=document.getElementById("gjs-canvas");a||(a=document.createElement("canvas"),a.setAttribute("id","gjs-canvas"),document.body.appendChild(a));return a},e=function(){var e={type:n()?f("gamejs/event").DISPLAY_FULLSCREEN_ENABLED:f("gamejs/event").DISPLAY_FULLSCREEN_DISABLED};if(n()&&l&a){var c=j();c.requestPointerLock=c.requestPointerLock||
c.mozRequestPointerLock||c.webkitRequestPointerLock;c.requestPointerLock&&c.requestPointerLock()}f("gamejs/event")._triggerCallback(e)};b.hasPointerLock=function(){return!(!document.pointerLockElement&&!document.webkitFullscreenElement&&!document.mozFullscreenElement&&!document.mozFullScreenElement)};b.init=function(){var a=j();a.getAttribute("tabindex")||(a.setAttribute("tabindex",1),a.focus());if(a=document.getElementById("gjs-loader"))a.style.display="none"};var n=b.isFullscreen=function(){return document.fullScreenElement||
document.mozFullScreen||document.webkitIsFullScreen||document.webkitDisplayingFullscreen},m=function(){var a=j();a.requestFullScreen=a.requestFullScreen||a.mozRequestFullScreen||a.webkitRequestFullScreen;if(!a.requestFullScreen)return!1;Element.ALLOW_KEYBOARD_INPUT?a.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT):a.requestFullScreen();return!0};b._hasFocus=function(){return document.activeElement==j()};b.setMode=function(d,k){c=null;var b=j();b.width=d[0];b.height=d[1];l=l||k;l&a&&(l|=g);if(l&
g){b=document.getElementById("gjs-fullscreen-toggle");if(!b){b=document.createElement("button");b.innerHTML="Fullscreen";b.id="gjs-fullscreen-toggle";var n=j();n.parentNode.insertBefore(b,n);n.parentNode.insertBefore(document.createElement("br"),n)}b.removeEventListener("click",m,!1);b.addEventListener("click",m,!1);document.removeEventListener("fullScreenchange",e,!1);document.removeEventListener("webkitfullscreenchange",e,!1);document.removeEventListener("mozfullscreenchange",e,!1);document.addEventListener("fullscreenchange",
e,!1);document.addEventListener("webkitfullscreenchange",e,!1);document.addEventListener("mozfullscreenchange",e,!1)}return o()};b.setCaption=function(a){document.title=a};b._isSmoothingEnabled=function(){return!(l&k)};b._getCanvasOffset=function(){var a=j().getBoundingClientRect();return[a.left,a.top]};var o=b.getSurface=function(){if(c===null){var a=j();c=new d([a.clientWidth,a.clientHeight]);c._canvas=a;c._context=a.getContext("2d");l&k?c._noSmooth():c._smooth()}return c}}},["gamejs","gamejs/event"]);
require.define({"gamejs/noise":function(f,b){var d=b.Simplex=function(c){c==void 0&&(c=Math);this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]];this.p=[];var d;for(d=0;d<256;d++)this.p[d]=Math.floor(c.random()*256);this.perm=[];for(d=0;d<512;d++)this.perm[d]=this.p[d&255];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,
0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]};d.prototype.dot=
function(c,d,g){return c[0]*d+c[1]*g};d.prototype.get=function(c,d){var g,a,l;l=(c+d)*0.5*(Math.sqrt(3)-1);var j=Math.floor(c+l),e=Math.floor(d+l),b=(3-Math.sqrt(3))/6;l=(j+e)*b;g=c-(j-l);var m=d-(e-l),f,p;g>m?(f=1,p=0):(f=0,p=1);a=g-f+b;var q=m-p+b;l=g-1+2*b;var b=m-1+2*b,r=j&255;e&=255;j=this.perm[r+this.perm[e]]%12;f=this.perm[r+f+this.perm[e+p]]%12;p=this.perm[r+1+this.perm[e+1]]%12;e=0.5-g*g-m*m;e<0?g=0:(e*=e,g=e*e*this.dot(this.grad3[j],g,m));m=0.5-a*a-q*q;m<0?a=0:(m*=m,a=m*m*this.dot(this.grad3[f],
a,q));q=0.5-l*l-b*b;q<0?l=0:(q*=q,l=q*q*this.dot(this.grad3[p],l,b));return 70*(g+a+l)};d.prototype.get3d=function(c,d,g){var a,l,j,e=(c+d+g)*(1/3),b=Math.floor(c+e),m=Math.floor(d+e),f=Math.floor(g+e),e=1/6;j=(b+m+f)*e;a=c-(b-j);l=d-(m-j);var p=g-(f-j),q,r,s,u,t,y;a>=l?l>=p?(q=1,s=r=0,t=u=1,y=0):(a>=p?(q=1,s=r=0):(r=q=0,s=1),u=1,t=0,y=1):l<p?(r=q=0,s=1,u=0,y=t=1):a<p?(q=0,r=1,u=s=0,y=t=1):(q=0,r=1,s=0,t=u=1,y=0);var v=a-q+e,z=l-r+e,A=p-s+e;j=a-u+2*e;var c=l-t+2*e,B=p-y+2*e,g=a-1+3*e,d=l-1+3*e,e=
p-1+3*e;b&=255;var D=m&255,C=f&255,m=this.perm[b+this.perm[D+this.perm[C]]]%12,f=this.perm[b+q+this.perm[D+r+this.perm[C+s]]]%12;u=this.perm[b+u+this.perm[D+t+this.perm[C+y]]]%12;b=this.perm[b+1+this.perm[D+1+this.perm[C+1]]]%12;t=0.6-a*a-l*l-p*p;t<0?a=0:(t*=t,a=t*t*this.dot(this.grad3[m],a,l,p));l=0.6-v*v-z*z-A*A;l<0?l=0:(l*=l,l=l*l*this.dot(this.grad3[f],v,z,A));v=0.6-j*j-c*c-B*B;v<0?j=0:(v*=v,j=v*v*this.dot(this.grad3[u],j,c,B));c=0.6-g*g-d*d-e*e;c<0?g=0:(c*=c,g=c*c*this.dot(this.grad3[b],g,d,
e));return 32*(a+l+j+g)}}},[]);
require.define({"gamejs/pathfinding/astar":function(f,b){function d(a){var j={};this.store=function(e,c){j[a(e)]=c};this.find=function(e){return j[a(e)]};return this}var c=f("../utils/binaryheap").BinaryHeap;b.findRoute=function(a,j,e,b){function m(a){p.push(a);q.store(a.point,a)}function f(j){var e=q.find(j),c=s.length+a.actualDistance(s.point,j);if(!e||e.length>c)e&&p.remove(e),m({point:j,from:s,length:c})}var p=new c(function(j){if(j.score===void 0)j.score=a.estimatedDistance(j.point,e)+j.length;
return j.score}),q=new d(typeof a.hash==="function"?a.hash:g),r=Date.now(),s=null;m({point:j,from:null,length:0});for(j=typeof a.equals==="function"?a.equals:k;p.size()>0&&(!b||Date.now()-r<b);){s=p.pop();if(j(e,s.point))return s;a.adjacent(s.point).forEach(f)}return null};var k=function(a,j){return a[0]===j[0]&&a[1]===j[1]},g=function(a){return a[0]+"-"+a[1]},a=b.Map=function(){throw Error("not instantiable, this is an interface");};a.prototype.adjacent=function(){};a.prototype.equals=k;a.prototype.hash=
g;a.prototype.estimatedDistance=function(){return 1};a.prototype.actualDistance=function(){return 1}}},["gamejs/utils/binaryheap"]);require.define({"gamejs/callback":function(f,b){(b.Callback=function(d,c){this.fn=d;this.fnScope=c||{};return this}).prototype.trigger=function(){this.fn.apply(this.fnScope,arguments)}}},[]);
require.define({"gamejs/tmx":function(f,b){var d=f("../gamejs");f("./utils/objects");var c=f("./xml"),k=f("./utils/base64"),g=f("./utils/uri");b.Map=function(e){var e=g.resolve(document.location.href,e),d=c.Document.fromURL(e).element("map");this.tileWidth=d.attribute("tilewidth");this.tileHeight=d.attribute("tileheight");this.width=d.attribute("width");this.height=d.attribute("height");if(d.attribute("orientation")!=="orthogonal")throw Error("only orthogonol maps supported");this.properties={};j(this.properties,
d);this.tiles=new a(d,e);this.layers=l(d);return this};b.Tile=function(){throw Error("Can not be instantiated.");};var a=b.TileSets=function(a,l){var b=[];this.getSurface=function(a){return(a=this.getTile(a))&&a.surface||null};this.getProperties=function(a){return(a=this.getTile(a))&&a.properties||{}};this.getTile=function(a){var j=null;b.some(function(e){if(e.firstGid<=a)return j=e.tiles[a-e.firstGid],!0;return!1},this);return j};var k=function(a){for(var e=[],c=a.attribute("tilewidth"),b=a.attribute("tileheight"),
k=a.attribute("spacing")||0,m=a.element("image").attribute("source"),m=g.makeRelative(g.resolve(l,m)),m=d.image.load(m),a=a.elements("tile"),f=m.getSize(),o=new d.Rect([0,0],[c,b]),z=0,A=0;A+b<=f[1];){for(x=0;x+c<=f[0];){var B=new d.Surface(c,b),D=new d.Rect([x,A],[c,b]);B.blit(m,o,D);var C={};a.some(function(a){if(a.attribute("id")===z)return j(C,a),!0},this);e.push({surface:B,properties:C});x+=c+k;z++}A+=b+k}return e};a.elements("tileset").forEach(function(a){var j=a.attribute("firstgid"),e=a.attribute("source");
e&&(a=c.Document.fromURL(g.resolve(l,e)).element("tileset"));b.push({tiles:k(a),firstGid:j})});b.reverse();return this},l=function(a){var c=[],l=function(a){var a=a.element("data"),j=a.attribute("encoding"),e=a.attribute("compression"),c="";a.children().forEach(function(a){c+=a.value()});var l=[];if(j==="base64"){if(e)throw Error("Compression of map data unsupported");l=k.decodeAsArray(c,4)}else if(j==="csv")c.trim().split("\n").forEach(function(a){a.split(",",d).forEach(function(a){l.push(parseInt(a,
10))})});else throw Error("individual tile format not supported");return l},d=a.attribute("width"),b=a.attribute("height");a.elements("layer").forEach(function(a){for(var e=[],g=b;g-- >0;){var k=d;for(e[g]=[];k-- >0;)e[g][k]=0}l(a).forEach(function(a,j){a&=1073741823;e[parseInt(j/d,10)][parseInt(j%d,10)]=a});c.push({gids:e,opacity:a.attribute("opacity"),visible:a.attribute("visible"),properties:j({},a)})});return c},j=function(a,j){var c=j.element("properties");if(c)return c.elements("property").forEach(function(j){var c=
j.attribute("name"),j=j.attribute("value");a[c]=j}),a}}},["gamejs","gamejs/utils/objects","gamejs/xml","gamejs/utils/base64","gamejs/utils/uri"]);
require.define({"gamejs/surfacearray":function(f,b){var d=f("../gamejs"),c=f("./utils/objects").accessors;b.blitArray=function(c,d){c.context.putImageData(d.imageData,0,0)};b.SurfaceArray=function(b){var g=null,a=null,l=null;this.set=function(j,e,c){j=j*4+e*g[0]*4;a[j]=c[0];a[j+1]=c[1];a[j+2]=c[2];a[j+3]=c[3]===void 0?255:c[3]};this.get=function(j,c){var l=j*4+c*g[0]*4;return[a[l],a[l+1],a[l+2],a[l+3]]};this.surface=null;c(this,{surface:{get:function(){var a=new d.Surface(g);a.context.putImageData(l,
0,0);return a}},imageData:{get:function(){return l}}});this.getSize=function(){return g};b instanceof Array?(g=b,l=d.display.getSurface().context.createImageData(g[0],g[1])):(g=b.getSize(),l=b.getImageData(0,0,g[0],g[1]));a=l.data;return this}}},["gamejs","gamejs/utils/objects"]);
require.define({"gamejs/utils/objects":function(f,b){b.extend=function(c,d){if(c===void 0)throw Error("unknown subClass");if(d===void 0)throw Error("unknown superClass");var a=new Function;a.prototype=d.prototype;c.prototype=new a;c.prototype.constructor=c;c.superClass=d.prototype;c.superConstructor=d};b.merge=function(){var c={},d,a;for(d=arguments.length;d>0;--d){var l=arguments[d-1];for(a in l)c[a]=l[a]}return c};var d=b.keys=function(c){if(Object.keys)return Object.keys(c);var d=[],a;for(a in c)Object.prototype.hasOwnProperty.call(c,
a)&&d.push(a);return d},c=b.accessor=function(c,d,a,l){Object.defineProperty!==void 0?Object.defineProperty(c,d,{get:a,set:l}):Object.prototype.__defineGetter__!==void 0&&(c.__defineGetter__(d,a),l&&c.__defineSetter__(d,l))};b.accessors=function(b,g){d(g).forEach(function(a){c(b,a,g[a].get,g[a].set)})}}},[]);
require.define({"gamejs/utils/prng":function(f,b){var d=function(){var a=4022871197;this.hash=function(c){var c=c.toString(),j;for(j=0;j<c.length;j++){a+=c.charCodeAt(j);var e=0.02519603282416938*a;a=e>>>0;e-=a;e*=a;a=e>>>0;e-=a;a+=e*4294967296}return(a>>>0)*2.3283064365386963E-10};this.version="Mash 0.9";return this},c=b.Alea=function(){var a=Array.prototype.slice.call(arguments),c=0,j=0,e=0,b=1;if(a.length==0||!a[0])a=[Date.now()];var g=new d,c=g.hash(" "),j=g.hash(" "),e=g.hash(" "),k;for(k=0;k<
a.length;k++)c-=g.hash(a[k]),c<0&&(c+=1),j-=g.hash(a[k]),j<0&&(j+=1),e-=g.hash(a[k]),e<0&&(e+=1);g=null;this.random=function(){var a=2091639*c+b*2.3283064365386963E-10;c=j;j=e;return e=a-(b=a|0)};return this},k=null,g=b.integer=function(a,c){return a+parseInt(k.random()*(c-a+1),10)};b.vector=function(a,c){return[g(a[0],c[0]),g(a[1],c[1])]};b.choose=function(a){return a[g(0,a.length-1)]};b.random=function(){return k.random()};b.init=function(a){k=new c(a)}}},["gamejs/utils/prng"]);
require.define({"gamejs/utils/strings":function(f,b){b.getCommonPrefix=function(d,c){if(d==null||c==null)return null;else if(d.length>c.length&&d.indexOf(c)==0)return c;else if(c.length>d.length&&c.indexOf(d)==0)return d;var b=Math.min(d.length,c.length),g;for(g=0;g<b;g++)if(d[g]!=c[g])return d.slice(0,g);return d.slice(0,b)}}},[]);
require.define({"gamejs/utils/uri":function(f,b){var d=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^/?#]*)@)?([\\w\\d\\-\\u0100-\\uffff.%]*)(?::([0-9]+))?)?([^?#]+)?(?:\\?([^#]*))?(?:#(.*))?$"),c=b.resolve=function(c,a){var d=k(c),j=k(a),e=d[1]+"://"+d[3];if(j[1])return a;d[4]&&(e=e+":"+d[4]);d=d[5];a.charAt(0)!=="/"?(j=d.lastIndexOf("/"),d=d.substr(0,j+1)+a):d=a;j=d;if(j==".."||j==".")d="";else{var d=j.indexOf("/")>-1,j=j.split("/"),b=[],m;for(m=0;m<j.length;){var f=j[m++];f=="."?d&&m==j.length&&b.push(""):
f==".."?((b.length>1||b.length==1&&b[0]!="")&&b.pop(),d&&m==j.length&&b.push("")):(b.push(f),d=!0)}d=b.join("/")}return e+d},k=b.match=function(c){return c.match(d)};b.makeRelative=function(d){var a=c(document.location.href,"./");d.indexOf(a)==0&&(d="./"+d.substring(a.length));return d}}},[]);
require.define({"gamejs/utils/base64":function(f,b){var d=b.decode=function(c){for(var d=[],b,a,l,j,e,n=0,c=c.replace(/[^A-Za-z0-9\+\/\=]/g,"");n<c.length;)b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c.charAt(n++)),a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c.charAt(n++)),j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c.charAt(n++)),e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c.charAt(n++)),
b=b<<2|a>>4,a=(a&15)<<4|j>>2,l=(j&3)<<6|e,d.push(String.fromCharCode(b)),j!=64&&d.push(String.fromCharCode(a)),e!=64&&d.push(String.fromCharCode(l));return d=d.join("")};b.decodeAsArray=function(c,b){var b=b||1,g=d(c),a=g.length/b,l=[],j,e;for(j=0;j<a;j++){l[j]=0;for(e=b-1;e>=0;--e)l[j]+=g.charCodeAt(j*b+e)<<(e<<3)}return l}}},[]);
require.define({"gamejs/utils/binaryheap":function(f,b){var d=b.BinaryHeap=function(c){this.content=[];this.scoreFunction=c;return this};d.prototype.push=function(c){this.content.push(c);this.sinkDown(this.content.length-1)};d.prototype.pop=function(){var c=this.content[0],d=this.content.pop();this.content.length>0&&(this.content[0]=d,this.bubbleUp(0));return c};d.prototype.remove=function(c){this.content.some(function(d,b){if(d==c){var a=this.content.pop();b!=this.content.length&&(this.content[b]=
a,this.scoreFunction(a)<this.scoreFunction(c)?this.sinkDown(b):this.bubbleUp(b));return!0}return!1},this)};d.prototype.size=function(){return this.content.length};d.prototype.sinkDown=function(c){for(var d=this.content[c];c>0;){var b=Math.floor((c+1)/2)-1,a=this.content[b];if(this.scoreFunction(d)<this.scoreFunction(a))this.content[b]=d,this.content[c]=a,c=b;else break}};d.prototype.bubbleUp=function(c){for(var d=this.content.length,b=this.content[c],a=this.scoreFunction(b);;){var l=(c+1)*2,j=l-1,
e=null;if(j<d){var n=this.scoreFunction(this.content[j]);n<a&&(e=j)}if(l<d&&this.scoreFunction(this.content[l])<(e===null?a:n))e=l;if(e!==null)this.content[c]=this.content[e],this.content[e]=b,c=e;else break}}}},[]);
require.define({"gamejs/utils/vectors":function(f,b){var d=f("./math");b.distance=function(a,d){return g(c(a,d))};var c=b.subtract=function(a,c){return[a[0]-c[0],a[1]-c[1]]};b.add=function(a,c){return[a[0]+c[0],a[1]+c[1]]};var k=b.multiply=function(a,c){if(typeof c==="number")return[a[0]*c,a[1]*c];return[a[0]*c[0],a[1]*c[1]]};b.divide=function(a,c){if(typeof c==="number")return[a[0]/c,a[1]/c];throw Error("only divide by scalar supported");};var g=b.len=function(a){return Math.sqrt(a[0]*a[0]+a[1]*
a[1])},a=b.unit=function(a){var c=g(a);if(c)return[a[0]/c,a[1]/c];return[0,0]};b.rotate=function(a,c){c=d.normaliseRadians(c);return[a[0]*Math.cos(c)-a[1]*Math.sin(c),a[0]*Math.sin(c)+a[1]*Math.cos(c)]};var l=b.dot=function(a,c){return a[0]*c[0]+a[1]*c[1]};b.angle=function(a,c){return Math.atan2(a[0]*c[1]-a[1]*c[0],l(a,c))};b.truncate=function(c,d){if(g(c)>d)return k(a(c),d);return c}}},["gamejs/utils/math"]);
require.define({"gamejs/utils/math":function(f,b){b.normaliseDegrees=function(d){d%=360;d<0&&(d+=360);return d};b.normaliseRadians=function(d){d%=2*Math.PI;d<0&&(d+=2*Math.PI);return d};b.degrees=function(d){return d*(180/Math.PI)};b.radians=function(d){return d*(Math.PI/180)};b.centroid=function(){var d=Array.prototype.slice.apply(arguments,[0]),c=[0,0];d.forEach(function(d){c[0]+=parseInt(d[0],10);c[1]+=parseInt(d[1],10)});d=d.length;return[c[0]/d,c[1]/d]}}},[]);
require.define({"gamejs/utils/arrays":function(f,b){b.remove=function(d,c){if(c.indexOf(d)!==-1)return c.splice(c.indexOf(d),1);return null};b.shuffle=function(d){for(i=d.length-1;i>0;i--){var c=parseInt(Math.random()*(i+1),10),b=d[i];d[i]=d[c];d[c]=b}return d}}},[]);
require.define({"gamejs/utils/matrix":function(f,b){b.identity=function(){return[1,0,0,1,0,0]};b.add=function(c,d){return[c[0]+d[0],c[1]+d[1],c[2]+d[2],c[3]+d[3],c[4]+d[4],c[5]+d[5],c[6]+d[6]]};var d=b.multiply=function(c,d){return[c[0]*d[0]+c[2]*d[1],c[1]*d[0]+c[3]*d[1],c[0]*d[2]+c[2]*d[3],c[1]*d[2]+c[3]*d[3],c[0]*d[4]+c[2]*d[5]+c[4],c[1]*d[4]+c[3]*d[5]+c[5]]};b.translate=function(c,b,g){return d(c,[1,0,0,1,b,g])};b.rotate=function(c,b){var g=Math.sin(b),a=Math.cos(b);return d(c,[a,g,-g,a,0,0])};
b.rotation=function(c){return Math.atan2(c[1],c[0])};b.scale=function(c,b){return d(c,[b[0],0,0,b[1],0,0])}}},[]);
require.define({"gamejs/time":function(f,b){var d=f("./callback").Callback,c=null;b._CALLBACK=new d(function(){},{});var k=typeof window!="undefined"?window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||null:null,g=function(){a();k(g)};b.init=function(){Date.now();k?k(g):setInterval(a,10)};var a=function(){var a=Date.now();b._CALLBACK.trigger(a-(c||a));c=a}}},["gamejs/callback"]);
require.define({"gamejs/font":function(f,b){var d=f("../gamejs").Surface,c=f("./utils/objects"),k=b.Font=function(c,a){this.sampleSurface=new d([10,10]);this.sampleSurface.context.font=c;this.sampleSurface.context.textAlign="start";this.sampleSurface.context.textBaseline="bottom";this.backgroundColor=a||!1;return this};k.prototype.render=function(c,a){var b=this.size(c),b=new d(b),j=b.context;j.save();if(this.backgroundColor)j.fillStyle=this.backgroundColor,j.fillRect(0,0,b.rect.width,b.rect.height);
j.font=this.sampleSurface.context.font;j.textBaseline=this.sampleSurface.context.textBaseline;j.textAlign=this.sampleSurface.context.textAlign;j.fillStyle=j.strokeStyle=a||"#000000";j.fillText(c,0,b.rect.height,b.rect.width);j.restore();return b};k.prototype.size=function(c){return[this.sampleSurface.context.measureText(c).width,this.fontHeight]};c.accessors(k.prototype,{fontHeight:{get:function(){return this.sampleSurface.context.measureText("M").width*1.5}}})}},["gamejs","gamejs/utils/objects"]);
require.define({"gamejs/xml":function(f,b){b.Parser=function(){var c=null,d=new DOMParser;this.parseFromString=function(b){return c=d.parseFromString(b,"text/xml")};return this};var d=b.Document=function(c){if(!c||!c instanceof XMLDocument)throw Error("Need a valid xmlDocument.");this._xmlDocument=c;return this};d.prototype.element=function(c){return(c=this._xmlDocument.getElementsByTagName(c)[0])&&new d(c)||null};d.prototype.elements=function(c){c=this._xmlDocument.getElementsByTagName(c);return Array.prototype.slice.apply(c,
[0]).map(function(c){return new d(c)})};d.prototype.attribute=function(c){c=(c=this._xmlDocument.getAttribute(c))?c.trim():null;if(c===null)return null;if(c.toLowerCase()==="true")return!0;if(c.toLowerCase()==="false")return!1;var d=parseInt(c,10),b=parseFloat(c,10);if(!isNaN(d)){if(b!==d)return b;return d}return c};d.prototype.value=function(){return this._xmlDocument.nodeValue};d.prototype.children=function(){return Array.prototype.slice.apply(this._xmlDocument.childNodes,[0]).map(function(c){return new d(c)})};
d.fromString=function(c){c=(new DOMParser).parseFromString(c,"text/xml");return new d(c)};d.fromURL=function(c){var b=new XMLHttpRequest;b.open("GET",c,!1);b.setRequestHeader("X-Requested-With","XMLHttpRequest");b.setRequestHeader("Content-Type","text/xml");b.overrideMimeType("text/xml");b.send();return new d(b.responseXML)}}},[]);
require.define({"gamejs/mixer":function(f,b){function d(a){a instanceof Array||(a=[a]);a.forEach(function(a){c[a.gamejsKey]=a})}f("../gamejs");var c={},k=!1,g=8;b.setNumChannels=function(a){g=parseInt(a,10)||g};b.getNumChannels=function(){return g};b.init=function(){var a=Array.prototype.slice.call(document.getElementsByTagName("audio"),0);d(a)};b.preload=function(a){function c(){d(this);g++;g==e&&(k=!1)}function b(){g++;g==e&&(k=!1);throw Error("Error loading "+this.src);}var e=0,g=0,m;for(m in a)if(!(m.indexOf("wav")==
-1&&m.indexOf("ogg")==-1&&m.indexOf("webm")==-1)){e++;var f=new Audio;f.addEventListener("canplay",c,!0);f.addEventListener("error",b,!0);f.src=a[m];f.gamejsKey=m;f.load()}e>0&&(k=!0);return function(){return e>0?g/e:1}};b.isPreloading=function(){return k};b.Sound=function(a){var d;d=typeof a==="string"?c[a]:a;if(!d)throw Error('Missing "'+a+'", gamejs.preload() all audio files before loading');for(var b=[],a=g;a-- >0;){var e=new Audio;e.preload="auto";e.loop=!1;e.src=d.src;b.push(e)}this.play=function(a){b.some(function(c){if(c.ended||
c.paused)return c.loop=!!a,c.play(),!0;return!1})};this.stop=function(){b.forEach(function(a){a.stop()})};this.setVolume=function(a){b.forEach(function(c){c.volume=a})};this.getVolume=function(){return b[0].volume};this.getLength=function(){return b[0].duration};return this}}},["gamejs"]);
require.define({"gamejs/image":function(f,b){var d=f("../gamejs"),c={};b.load=function(b){var g;if(typeof b==="string"){if(g=c[b],!g)throw Error('Missing "'+b+'", gamejs.preload() all images before trying to load them.');}else g=b;b=document.createElement("canvas");b.width=g.naturalWidth||g.width;b.height=g.naturalHeight||g.height;var a=b.getContext("2d");a.drawImage(g,0,0);g.getSize=function(){return[g.naturalWidth,g.naturalHeight]};var l=new d.Surface(g.getSize());l._canvas=b;l._context=a;return l};
b.init=function(){};b.preload=function(b){function g(){j++;j%10===0&&d.log("gamejs.image: preloaded  "+j+" of "+e)}function a(){c[this.gamejsKey]=this;g()}function l(){g();throw Error("Error loading "+this.src);}var j=0,e=0,n;for(n in b){var f=n.toLowerCase();if(!(f.indexOf(".png")==-1&&f.indexOf(".jpg")==-1&&f.indexOf(".jpeg")==-1&&f.indexOf(".svg")==-1&&f.indexOf(".gif")==-1))f=new Image,f.addEventListener("load",a,!0),f.addEventListener("error",l,!0),f.src=b[n],f.gamejsKey=n,e++}return function(){return e>
0?j/e:1}}}},["gamejs"]);
require.define({"gamejs/event":function(f,b){var d=f("./display"),c=f("./callback").Callback;b._CALLBACK=new c(function(){},{});b._triggerCallback=function(){b._CALLBACK.trigger.apply(b._CALLBACK,arguments)};b.K_UP=38;b.K_DOWN=40;b.K_RIGHT=39;b.K_LEFT=37;b.K_SPACE=32;b.K_BACKSPACE=8;b.K_TAB=9;b.K_ENTER=13;b.K_SHIFT=16;b.K_CTRL=17;b.K_ALT=18;b.K_ESC=27;b.K_0=48;b.K_1=49;b.K_2=50;b.K_3=51;b.K_4=52;b.K_5=53;b.K_6=54;b.K_7=55;b.K_8=56;b.K_9=57;b.K_a=65;b.K_b=66;b.K_c=67;b.K_d=68;b.K_e=69;b.K_f=70;b.K_g=
71;b.K_h=72;b.K_i=73;b.K_j=74;b.K_k=75;b.K_l=76;b.K_m=77;b.K_n=78;b.K_o=79;b.K_p=80;b.K_q=81;b.K_r=82;b.K_s=83;b.K_t=84;b.K_u=85;b.K_v=86;b.K_w=87;b.K_x=88;b.K_y=89;b.K_z=90;b.K_KP1=97;b.K_KP2=98;b.K_KP3=99;b.K_KP4=100;b.K_KP5=101;b.K_KP6=102;b.K_KP7=103;b.K_KP8=104;b.K_KP9=105;b.NOEVENT=0;b.NUMEVENTS=32E3;b.DISPLAY_FULLSCREEN_ENABLED=300;b.DISPLAY_FULLSCREEN_DISABLED=301;b.QUIT=0;b.KEY_DOWN=1;b.KEY_UP=2;b.MOUSE_MOTION=3;b.MOUSE_UP=4;b.MOUSE_DOWN=5;b.MOUSE_WHEEL=6;b.USEREVENT=2E3;b.Event=function(){this.pos=
this.button=this.rel=this.key=this.type=null};b.init=function(){function c(a){var j=d._getCanvasOffset();b._CALLBACK.trigger({type:b.MOUSE_WHEEL,pos:[a.clientX-j[0],a.clientY-j[1]],delta:a.detail||-a.wheelDeltaY/40})}var g=[],a=d.getSurface()._canvas;document.addEventListener("mousedown",function(a){var c=d._getCanvasOffset();b._CALLBACK.trigger({type:b.MOUSE_DOWN,pos:[a.clientX-c[0],a.clientY-c[1]],button:a.button,shiftKey:a.shiftKey,ctrlKey:a.ctrlKey,metaKey:a.metaKey})},!1);document.addEventListener("mouseup",
function(a){var c=d._getCanvasOffset();b._CALLBACK.trigger({type:b.MOUSE_UP,pos:[a.clientX-c[0],a.clientY-c[1]],button:a.button,shiftKey:a.shiftKey,ctrlKey:a.ctrlKey,metaKey:a.metaKey})},!1);document.addEventListener("keydown",function(a){var c=a.keyCode||a.which;b._CALLBACK.trigger({type:b.KEY_DOWN,key:c,shiftKey:a.shiftKey,ctrlKey:a.ctrlKey,metaKey:a.metaKey});(d._hasFocus()&&!a.ctrlKey&&!a.metaKey&&(c>=b.K_LEFT&&c<=b.K_DOWN||c>=b.K_0&&c<=b.K_z||c>=b.K_KP1&&c<=b.K_KP9||c===b.K_SPACE||c===b.K_TAB||
c===b.K_ENTER)||c===b.K_ALT||c===b.K_BACKSPACE)&&a.preventDefault()},!1);document.addEventListener("keyup",function(a){b._CALLBACK.trigger({type:b.KEY_UP,key:a.keyCode,shiftKey:a.shiftKey,ctrlKey:a.ctrlKey,metaKey:a.metaKey})},!1);document.addEventListener("mousemove",function(a){var c=d._getCanvasOffset(),c=[a.clientX-c[0],a.clientY-c[1]],e=[];g.length&&(e=[g[0]-c[0],g[1]-c[1]]);b._CALLBACK.trigger({type:b.MOUSE_MOTION,pos:c,rel:e,buttons:null,timestamp:a.timeStamp,movement:[a.movementX||a.mozMovementX||
a.webkitMovementX||0,a.movementY||a.mozMovementY||a.webkitMovementY||0]});g=c},!1);a.addEventListener("mousewheel",c,!1);a.addEventListener("DOMMouseScroll",c,!1);a.addEventListener("beforeunload",function(){b._CALLBACK.trigger({type:b.QUIT})},!1)}}},["gamejs/display","gamejs/callback"]);
require.define({"gamejs/mask":function(f,b){var d=f("../gamejs"),c=f("./utils/objects");b.fromSurface=function(c,a){var a=a&&255-a||255,d=c.getImageData().data,b=c.getSize(),e=new k(b),f;for(f=0;f<d.length;f+=4){var m=parseInt(f/4/b[0],10),o=parseInt(f/4%b[0],10);d[f+3]>=a&&e.setAt(o,m)}return e};var k=b.Mask=function(c){this.width=c[0];this.height=c[1];this._bits=[];for(var a,c=0;c<this.width;c++){this._bits[c]=[];for(a=0;a<this.height;a++)this._bits[c][a]=!1}};k.prototype.overlapRect=function(c,
a){var b=this.rect,j=c.rect;a&&j.moveIp(a);if(!j.collideRect(b))return null;var e=Math.max(b.left,j.left),f=Math.max(b.top,j.top);return new d.Rect([e,f],[Math.min(b.right,j.right)-e,Math.min(b.bottom,j.bottom)-f])};k.prototype.overlap=function(c,a){var d=this.overlapRect(c,a);if(d===null)return!1;var b=this.rect,e=c.rect;a&&e.moveIp(a);var f,k;for(k=d.top;k<=d.bottom;k++)for(f=d.left;f<=d.right;f++)if(this.getAt(f-b.left,k-b.top)&&c.getAt(f-e.left,k-e.top))return!0;return!1};k.prototype.overlapArea=
function(c,a){var d=this.overlapRect(c,a);if(d===null)return 0;var b=this.rect,e=c.rect;a&&e.moveIp(a);var f=0,k,o;for(o=d.top;o<=d.bottom;o++)for(k=d.left;k<=d.right;k++)this.getAt(k-b.left,o-b.top)&&c.getAt(k-e.left,o-e.top)&&f++;return f};k.prototype.overlapMask=function(c,a){var d=this.overlapRect(c,a);if(d===null)return 0;var b=this.rect,e=c.rect;a&&e.moveIp(a);var f=new k([d.width,d.height]),m,o;for(o=d.top;o<=d.bottom;o++)for(m=d.left;m<=d.right;m++)this.getAt(m-b.left,o-b.top)&&c.getAt(m-
e.left,o-e.top)&&f.setAt(m,o);return f};k.prototype.setAt=function(c,a){this._bits[c][a]=!0};k.prototype.getAt=function(c,a){c=parseInt(c,10);a=parseInt(a,10);if(c<0||a<0||c>=this.width||a>=this.height)return!1;return this._bits[c][a]};k.prototype.invert=function(){this._bits=this._bits.map(function(c){return c.map(function(a){return!a})})};k.prototype.getSize=function(){return[this.width,this.height]};c.accessors(k.prototype,{rect:{get:function(){return new d.Rect([0,0],[this.width,this.height])}},
length:{get:function(){var c=0;this._bits.forEach(function(a){a.forEach(function(a){a&&c++})});return c}}})}},["gamejs","gamejs/utils/objects"]);
require.define({"gamejs/worker":function(f,b){function d(a){var c=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return a+"@"+(c()+c())}var c=f("../gamejs"),k=f("./utils/uri"),g=f("./callback").Callback,a=b._EVENTS={RESULT:1001,ALIVE:1002,LOG:1004},l=b.inWorker=this.importScripts!==void 0;b._ready=function(){self.onmessage=function(a){c.event._triggerCallback(a.data)};self.postMessage({type:a.ALIVE})};b.post=function(c){if(l)self.postMessage({type:a.RESULT,data:c});else throw Error("gamejs.postMessage only available in a gamejs/worker module");
};b._logMessage=function(){self.postMessage({type:a.LOG,arguments:Array.prototype.slice.apply(arguments)})};var j=function(){__scripts.forEach(function(a){try{importScripts(a)}catch(c){}})},e=function(a){var c=k.resolve(document.location.href,window.require.getModuleRoot()),d=[];Array.prototype.slice.apply(document.getElementsByTagName("script"),[0]).forEach(function(a){a.src&&d.push(a.src)});var b=window.URL||window.webkitURL,e=j.toString(),e=e.substring(e.indexOf("{")+1,e.lastIndexOf("}")),a=new Blob(['var __scripts = ["'+
d.join('","')+'"];',e,';self.require.setModuleRoot("'+c+'");','self.require.run("'+a+'");'],{type:"application/javascript"}),b=b.createObjectURL(a);return new Worker(b)};b.Worker=function(b){var j=this.id=d(b),l=e(b),f=[],k=!1,r=this,s=new g(function(){},{}),u=new g(function(){},{});l.onmessage=function(d){d.data.type===a.ALIVE?(k=!0,f.forEach(function(a){r.post(a)})):d.data.type===a.LOG?c.log.apply(null,[j].concat(d.data.arguments)):s.trigger(d.data.data)};l.onerror=function(a){c.error('Error in worker "'+
j+'" line '+a.lineno+": ",a.message);u.trigger({data:a.data,worker:r,event:a})};this.onEvent=function(a,c){s=new g(a,c)};this.onError=function(a,c){u=new g(a,c)};this.post=function(a){k?l.postMessage(a):f.push(a)};return this}}},["gamejs","gamejs/utils/uri","gamejs/callback"]);
require.define({"gamejs/sprite":function(f,b){f("../gamejs");var d=f("./utils/arrays"),c=f("./utils/objects"),k=f("./utils/vectors"),g=b.Sprite=function(){this._groups=[];this._alive=!0;this.rect=this.image=null;c.accessor(this,"groups",function(){return this._groups});return this};g.prototype.kill=function(){this._alive=!1;this._groups.forEach(function(a){a.remove(this)},this)};g.prototype.remove=function(a){a instanceof Array||(a=[a]);a.forEach(function(a){a.remove(this)},this)};g.prototype.add=
function(a){a instanceof Array||(a=[a]);a.forEach(function(a){a.add(this)},this)};g.prototype.groups=function(){return this._groups.slice(0)};g.prototype.draw=function(a){a.blit(this.image,this.rect)};g.prototype.update=function(){};g.prototype.isDead=function(){return!this._alive};var a=b.Group=function(a){this._sprites=[];(a instanceof g||a instanceof Array&&a.length&&a[0]instanceof g)&&this.add(a);return this};a.prototype.update=function(){var a=arguments;this._sprites.forEach(function(c){c.update.apply(c,
a)},this)};a.prototype.add=function(a){a instanceof Array||(a=[a]);a.forEach(function(a){this._sprites.push(a);a._groups.push(this)},this)};a.prototype.remove=function(a){a instanceof Array||(a=[a]);a.forEach(function(a){d.remove(a,this._sprites);d.remove(this,a._groups)},this)};a.prototype.has=function(a){a instanceof Array||(a=[a]);return a.every(function(a){return this._sprites.indexOf(a)!==-1},this)};a.prototype.sprites=function(){return this._sprites};a.prototype.draw=function(){var a=arguments;
this._sprites.forEach(function(c){c.draw.apply(c,a)},this)};a.prototype.clear=function(a,c){this._sprites.forEach(function(d){a.blit(c,d.rect)},this)};a.prototype.empty=function(){this._sprites=[]};a.prototype.collidePoint=function(){var a=Array.prototype.slice.apply(arguments);return this._sprites.filter(function(c){return c.rect.collidePoint.apply(c.rect,a)},this)};a.prototype.forEach=function(a,c){return this._sprites.forEach(a,c)};a.prototype.some=function(a,c){return this._sprites.some(a,c)};
b.spriteCollide=function(a,c,d,b){var b=b||l,d=d||!1,g=[];c.sprites().forEach(function(c){b(a,c)&&(d&&c.kill(),g.push(c))});return g};b.groupCollide=function(a,c,d,b,g){var d=d||!1,b=b||!1,f=[],k=g||l;a.sprites().forEach(function(a){c.sprites().forEach(function(c){k(a,c)&&(d&&a.kill(),b&&c.kill(),f.push({a:a,b:c}))})});return f};var l=b.collideRect=function(a,c){return a.rect.collideRect(c.rect)};b.collideMask=function(a,c){if(!a.mask||!c.mask)throw Error("Both sprites must have 'mask' attribute set to an gamejs.mask.Mask");
return a.mask.overlap(c.mask,[c.rect.left-a.rect.left,c.rect.top-a.rect.top])};b.collideCircle=function(a,c){var d=a.radius||Math.max(a.rect.width,a.rect.height),b=c.radius||Math.max(c.rect.width,c.rect.height);return k.distance(a.rect.center,c.rect.center)<=d+b}}},["gamejs","gamejs/utils/arrays","gamejs/utils/objects","gamejs/utils/vectors"]);
require.define({"gamejs/http":function(f,b){function d(a){return eval("("+a.responseText+")")}b.Response=function(){this.getResponseHeader=function(){};throw Error("response class not instantiable");};var c=b.ajax=function(a,c,d,b){var d=d||null,g=new XMLHttpRequest;g.open(a,c,!1);b&&g.setRequestHeader("Accept",b);d instanceof Object&&(d=JSON.stringify(d),g.setRequestHeader("Content-Type","application/json"));g.setRequestHeader("X-Requested-With","XMLHttpRequest");g.send(d);return g},k=b.get=function(a){return c("GET",
a)},g=b.post=function(a,d,b){return c("POST",a,d,b)};b.load=function(a){return d(k((window.$g&&window.$g.ajaxBaseHref||"./")+a))};b.save=function(a,c,b){return d(g((window.$g&&window.$g.ajaxBaseHref||"./")+a,{payload:c},b))}}},[]);
require.define({aidirector:function(f,b){var d=f("gamejs");f("gamejs/utils/vectors");var c=f("./particles"),k=f("./sounds");b.AiDirector=function(b,a,l){var j=[],e=DEBUG?1E3:4E4,n=0,m=[["skull"],["skull","skull"],["skull","skull","skull"],["skull","skull","wind"],["skull","wind","wind"],["skull","wind","blob"],["skull","blob","blob","blob"],["blob","wind","wind","fire"],["skull","blob","blob","wind","fire"]],o=!1;this.update=function(p){if(a.getFlockLength()===0&&(e-=p,n===m.length)){f("./stats").victory();
return}e<7E3&&!o&&(o=!0,k.play("clock"));var s=!1;if(e<=0){e=2E4;if(n>=m.length){n=0;return}f("./stats").count("wave");s=!0;o=!1;k.play("eruption");a.emptyCoins();m[n].forEach(function(e){d.utils.arrays.shuffle(q);for(var f=q[0].pos,k=0;k<1;k++)a.addCoin(l.getPosition(f,150,!0));a.createEnemyFlock({type:e,pos:l.getPosition(f,150,!0),target:b.rect.center});e=new c.Emitter({delay:300,numParticles:20,modifierFunc:c.Modifiers.ring(30,3,"rgba(240,233,50,0.1)")});e.pos=f;e.start();j.push({emitter:e,age:0})});
n++}j=j.filter(function(a){a.age+=p;if(a.age>3E3)return a.emitter.stop(),a.emitter=null,!1;a.emitter.update(p);return!0});if(s)return"next-wave"};this.draw=function(a,c){j.forEach(function(d){d.emitter.draw(a,c)})};this.drawGui=function(c){a.getFlockLength()===0&&c.blit(p.render("Eruption "+(n+1)+" of "+m.length+" in "+(e/1E3|0)+" seconds.","white"),[10,10])};var p=new d.font.Font("25px 'Aladin', cursive"),q=l.bases;return this}}},["gamejs","gamejs/utils/vectors","particles","sounds","stats"]);
require.define({"prng/alea":function(f,b){var d=f("./mash").Mash;b.Alea=function(){return function(c){var b=0,g=0,a=0,l=1;c.length==0&&(c=[+new Date]);for(var j=d(),b=j(" "),g=j(" "),a=j(" "),e=0;e<c.length;e++)b-=j(c[e]),b<0&&(b+=1),g-=j(c[e]),g<0&&(g+=1),a-=j(c[e]),a<0&&(a+=1);var j=null,f=function(){var c=2091639*b+l*2.3283064365386963E-10;b=g;g=a;return a=c-(l=c|0)};f.uint32=function(){return f()*4294967296};f.fract53=function(){return f()+(f()*2097152|0)*1.1102230246251565E-16};f.version="Alea 0.9";
f.args=c;return f}(Array.prototype.slice.call(arguments))}}},["prng/mash"]);require.define({"prng/mash":function(f,b){b.Mash=function(){var d=4022871197,c=function(c){for(var c=c.toString(),b=0;b<c.length;b++){d+=c.charCodeAt(b);var a=0.02519603282416938*d;d=a>>>0;a-=d;a*=d;d=a>>>0;a-=d;d+=a*4294967296}return(d>>>0)*2.3283064365386963E-10};c.version="Mash 0.9";return c}}},[]);
require.define({muzzle:function(f,b){var d=f("gamejs"),c=f("gamejs/utils/vectors"),k={};k.DIRECTIONS={n:{cartasian:[0,-1],angle:270},s:{cartasian:[0,1],angle:90},w:{cartasian:[-1,0],angle:180},e:{cartasian:[1,0],angle:0},nw:{cartasian:c.unit([-1,-1]),angle:225},ne:{cartasian:c.unit([1,-1]),angle:315},sw:{cartasian:c.unit([-1,1]),angle:135},se:{cartasian:c.unit([1,1]),angle:45}};var g=b.Muzzle=function(a){this.active=!1;this.countdown=g.COUNTDOWN;this.visible=!1;this.rect=a;this.offset=[0,0];g.IMAGE=
d.image.load("./images/muzzle.png");this.setDirection("e");return this};g.DIRECTIONS={n:{offset:[-2,-20]},s:{offset:[-2,5]},w:{offset:[-17,0]},e:{offset:[2,0]},nw:{offset:[-15,-15]},ne:{offset:[2,-10]},sw:{offset:[-13,0]},se:{offset:[0,0]}};g.COUNTDOWN=30;g.prototype.draw=function(a,d){this.active&&this.visible&&a.blit(this.image,c.subtract(c.add(this.rect.center,g.DIRECTIONS[this.direction].offset),d.topleft))};g.prototype.update=function(a){if(this.active&&(this.countdown-=a,this.countdown<=0))this.countdown=
g.COUNTDOWN,this.visible=!this.visible};g.prototype.setDirection=function(a){this.direction=a;this.image=d.transform.rotate(g.IMAGE,k.DIRECTIONS[this.direction].angle)}}},["gamejs","gamejs/utils/vectors"]);
require.define({flockmanager:function(f,b){var d=f("gamejs"),c=f("gamejs/utils/vectors"),k=f("./boids/flock").Flock,g=f("./mob"),a=f("./coin").Coin,l=f("./sounds"),j=f("./prng"),e={wind:{frameMs:250,speed:100,weapon:"melee",health:0.15,groupMinMax:[20,28],spriteSheet:{image:"./images/units/wind.png",cols:3,rows:4,directions:{n:{animation:0},s:{animation:2},w:{animation:3},e:{animation:1},nw:{animation:0},ne:{animation:0},sw:{animation:2},se:{animation:2}}}},skull:{frameMs:150,speed:80,weapon:"melee",
health:0.3,groupMinMax:[6,8],spriteSheet:{image:"./images/units/skull.png",cols:3,rows:4,directions:{n:{animation:1},s:{animation:0},w:{animation:3},e:{animation:2},ne:{animation:1},nw:{animation:1},se:{animation:0},sw:{animation:0}}}},fire:{frameMs:250,speed:20,weapon:"projectile",groupMinMax:[2,3],health:0.5,spriteSheet:{image:"./images/units/fire.png",cols:3,rows:4,directions:{n:{animation:0},s:{animation:2},w:{animation:3},e:{animation:1},nw:{animation:0},ne:{animation:0},sw:{animation:2},se:{animation:2}}}},
blob:{frameMs:400,speed:30,groupMinMax:[6,8],health:0.3,weapon:"gauntling",spriteSheet:{image:"./images/units/blobs.png",cols:3,rows:4,directions:{n:{animation:1},s:{animation:1},w:{animation:1},e:{animation:1},ne:{animation:1},nw:{animation:1},se:{animation:1},sw:{animation:1}}}},cultist:{frameMs:200,speed:30,weapon:"melee",health:0.3,groupMinMax:[15,20],spriteSheet:{image:"./images/units/cultist.png",cols:3,rows:4,directions:{n:{animation:0},s:{animation:2},w:{animation:3},e:{animation:1},nw:{animation:0},
ne:{animation:0},sw:{animation:2},se:{animation:2}}}},captain:{frameMs:250,speed:80,weapon:"gauntling",spriteSheet:{image:"./images/units/captain.png",cols:3,rows:4,directions:{n:{animation:0},s:{animation:2},w:{animation:3},e:{animation:1},nw:{animation:3},ne:{animation:1},sw:{animation:3},se:{animation:1}}}},pirate:{health:0.5,frameMs:150,speed:45,weapon:"gauntling",spriteSheet:{image:"./images/units/pirate.png",cols:3,rows:4,directions:{n:{animation:0},s:{animation:2},w:{animation:3},e:{animation:1},
nw:{animation:3},ne:{animation:1},sw:{animation:3},se:{animation:1}}}}};b.FlockManager=function(b,m,o){var p=null;this.setPlayer=function(a){p=a};var q={"goto":function(a){var b=a.blackboard;if(b.gotoPath&&(!a.target||a.target&&c.distance(a.target,a.center)<10))b.gotoIdx++,b.gotoIdx>=b.gotoPath.length?(d.info("Flock reached final position",a.center),b.gotoPath=null,b.state="stopped"):a.target=b.gotoPath[b.gotoIdx]},attackIfInSight:function(a,b){var e=d.sprite.spriteCollide({radius:Math.min(a.boids[0].speed*
8,300),rect:new d.Rect(a.center)},b,!1,d.sprite.collideCircle).sort(function(d,b){var e=c.distance(a.center,d.rect.center),j=c.distance(a.center,b.rect.center);if(e>j)return 1;if(e<j)return-1;return 0});e.length&&(d.info("attackIfInSight: got enemy in sight"),a.weapon==="melee"||a.weapon==="gauntling"?this.asyncRoute(a,a.center,e[0].rect.center):a.weapon==="projectile"&&q.fire(a))},startGoto:function(a,c){if(!c||!c.length)a.blackboard.state="errorpath",d.info("startGoto but no path given",a,c);else if(c.length){d.info("startGoto success",
c);a.blackboard=a.blackboard||{};if(a.blackboard.state==="goto")a.blackboard.oldGotoPath=a.blackboard.gotoPath&&a.blackboard.gotoPath.slice(0);a.blackboard.state="goto";a.blackboard.gotoIdx=0;a.blackboard.gotoPath=c.slice(0);a.target=a.blackboard.gotoPath[0]}},fire:function(a){d.info("Fireing");a.blackboard.state="fireing"}},r=500,s=function(a,c){if(!(a.boids.length<=0)&&r<=0&&a.blackboard.state!=="guard"){if(a.blackboard.state==="goto")q["goto"](a);!a.isPlayer&&(a.blackboard.state!=="goto"||!a.blackboard.oldGotoPath)&&
q.attackIfInSight.apply(this,[a,c]);if(a.blackboard.state==="stopped"&&a.blackboard.oldGotoPath)this.asyncRoute(a,a.center,a.blackboard.oldGotoPath[a.blackboard.oldGotoPath.length-1]),a.blackboard.oldGotoPath=null;a.blackboard.state==="stopped"&&this.asyncRoute(a,a.center,p.rect.center)}};this.addCoin=function(c){y.add(new a(c))};this.emptyCoins=function(){y.empty()};this.update=function(a){var n;var c=d.sprite.spriteCollide(p,y,!0,d.sprite.CollideCircle);c.length&&(p.coins+=c.length||0,f("./stats").count("coin"),
l.play("money"));y.update(a);r-=a;t.forEach(function(c){if(!(c.boids.length<=0)){c.blackboard.state!=="stopped"&&c.update(a);if(c.blackboard.state==="following")c.target=t[0].boids[0].pos;r<0&&s.apply(this,[c,m])}},this);if(r<0)t=t.filter(function(a){return a.boids.length>0}),n=window.flocks=u.filter(function(a){var c=a.boids.length>0;c||(d.info("Removing flock",a),j.random()<0.4&&this.addCoin(a.center));return c},this),u=n;u.forEach(function(c){c.blackboard.state!=="stopped"&&c.update(a);r<0&&s.apply(this,
[c,b])},this);r<0&&(r=1E3)};this.draw=function(a,b){y.draw(a,b);DEBUG&&u.concat(t).forEach(function(e){if(e.blackboard.state==="goto"&&e.blackboard.gotoPath){var j=e.blackboard.gotoPath.map(function(a){return c.subtract(a,b.topleft)}),g="rgba(0,0,255,0.8)";e.blackboard.oldGotoPath&&(g="rgba(177,0,0,0.8)");d.draw.lines(a,g,!1,j,1);j.length&&e.blackboard.gotoIdx<j.length&&(d.draw.circle(a,g,j[e.blackboard.gotoIdx],5,0),d.draw.circle(a,g,j[j.length-1],10,1))}})};this.createFriendlyFlock=function(){var a=
new k({chunk:o});a.blackboard={state:"following"};t.push(a);a.update(0);return a};this.addBoid=function(a){var c=e[a.type],b=o.getPosition(a.center,100,!0),j=d.utils.objects.merge(c,{});j.pos=b;b=new g.Unit([0,0],j);b.boid=a.createBoid(j);b.boid.speed=c.speed;b.rect.center=b.boid.pos;return b};this.asyncRoute=function(a,c,b){if(!a.waitingForRoute){d.log("Starting async route",c);c=o.viewToMap(c);b=o.viewToMap(b);c.reverse();b.reverse();var e=Date.now()+j.random()*Date.now();z.post({type:"findRoute",
origin:c,destination:b,id:e});a.waitingForRoute=!0;v[e]=function(c){d.info("Worker path receieved, ms",c.duration);a.waitingForRoute=!1;c.route.length>0?q.startGoto(a,c.route.slice(1)):a.blackboard.state="errorpath"}}};this.createEnemyFlock=function(a){if(!(u.length>5)){var c=a.type,d=a.pos||o.getPosition(),b=a.target||o.getPosition(d,100,!0),g=new k({chunk:o});g.type=c;g.center=d;a=e[c];for(c=j.rand(a.groupMinMax[0],a.groupMinMax[1]);c-- >0;){var l=this.addBoid(g);m.add(l)}g.blackboard={};g.weapon=
a.weapon;this.asyncRoute(g,d,b);g.target=l.rect.center;u.push(g)}};this.getFlockLength=function(){return u.length};var u=window.flocks=[],t=[],y=new d.sprite.Group,v={},z=new d.worker.Worker("./workers/astar");z.post({type:"mapdata",map:o.data});z.onEvent(function(a){v[a.id](a)});return this}}},["gamejs","gamejs/utils/vectors","boids/flock","mob","coin","sounds","prng","stats"]);
require.define({shop:function(f,b){var d=f("gamejs"),c=f("gamejs/utils/vectors");f("gamejs/utils/prng");var k=f("gamejs/utils/arrays"),g=f("gamejs/utils/math"),a=f("./sounds");b.Shop=function(b,j,e,n){this.drawGui=function(a,b,e){b=n.mapToView(o[u]);e=c.angle([1,0],c.subtract(b,e.center));e=d.transform.rotate(y,g.degrees(e));b=[DISPLAY_DIMS[0]/2-e.getSize()[0]/2,5];a.blit(e,b)};this.draw=function(a,b){var d=n.mapToView(o[u]),d=c.subtract(d,b.topleft);a.blit(t,d)};this.nextShop=function(){u++;u>=s.length&&
(u=0);d.log("Active shop is now at ",o[u])};this.show=function(){z.textContent=b.coins;A.textContent=b.bombs;v.style.display="block"};this.hide=function(){v.style.display="none"};this.contains=function(a){return c.distance(o[u],a)<2};for(var m=[[70,70,70,70,70,70,70,70,70,70,70,70,70,70],[70,70,70,70,70,70,70,70,70,70,70,70,70,70],[70,70,150,150,150,150,150,150,150,150,150,150,70,70],[70,70,150,256,256,256,256,256,256,256,256,150,70,70],[70,70,150,256,150,150,150,150,150,150,256,150,70,70],[70,70,
150,256,150,150,264,150,150,150,256,150,70,70],[70,70,150,256,150,150,150,150,150,150,256,150,70,70],[70,70,150,256,256,150,150,150,150,256,256,150,70,70],[70,70,150,150,150,150,150,150,150,150,150,150,70,70],[70,70,150,150,150,150,150,150,150,150,150,150,70,70],[70,70,150,256,256,256,256,256,256,256,256,150,70,70],[70,70,150,150,150,150,150,150,150,150,150,150,70,70],[70,70,70,70,70,70,70,70,70,70,70,70,70,70],[70,70,70,70,70,70,70,70,70,70,70,70,70,70]],o=[],p=n.getSpiralPosGenerator(),q=0;q<3;q++){var r=
p();m.forEach(function(a,b){a.forEach(function(a,d){var e=n.viewToMap(c.add(r,[b*16,d*16]));n.modify(e,a,!0);(a===258||a===264)&&o.push(e)})});n.renderer.redraw(new d.Rect(n.viewToMap(r),[m[0].length,m.length]));d.log("Created shop at "+r)}var s=Object.keys(o).map(function(a){return parseInt(a,10)});k.shuffle(s);var u=0,t=d.image.load("./images/blueglow.png"),y=d.image.load("./images/arrow.png"),v=document.getElementById("km-shop"),z=document.getElementById("km-shop-coins"),A=document.getElementById("km-shop-bombs");
document.getElementById("km-shop-buypirate").addEventListener("mouseup",function(){if(!(b.coins<2))e.add(j.addBoid(b.boid.flock)),b.coins-=2,a.play("money"),f("./stats").count("pirate"),z.textContent=b.coins},!1);document.getElementById("km-shop-buyheal").addEventListener("mouseup",function(){if(!(b.coins<=0))b.health=1,b.coins--,a.play("money"),z.textContent=b.coins},!1);document.getElementById("km-shop-buybomb").addEventListener("mouseup",function(){if(!(b.coins<=0))b.coins--,a.play("money"),b.bombs+=
3,z.textContent=b.coins,A.textContent=b.bombs},!1);var B=this;document.body.addEventListener("keydown",function(a){a.keyCode===27&&(B.hide(),d.log("hiding"))},!1)}}},["gamejs","gamejs/utils/vectors","gamejs/utils/prng","gamejs/utils/arrays","gamejs/utils/math","sounds","stats"]);
require.define({gamejs:function(f,b){function d(){var a=0,c=0,b=0,d=0;if(arguments.length===2)arguments[0]instanceof Array&&arguments[1]instanceof Array?(a=arguments[0][0],c=arguments[0][1],b=arguments[1][0],d=arguments[1][1]):(a=arguments[0],c=arguments[1]);else if(arguments.length===1&&arguments[0]instanceof Array)a=arguments[0][0],c=arguments[0][1],b=arguments[0][2],d=arguments[0][3];else if(arguments.length===1&&arguments[0]instanceof e)a=arguments[0].left,c=arguments[0].top,b=arguments[0].width,
d=arguments[0].height;else if(arguments.length===4)a=arguments[0],c=arguments[1],b=arguments[2],d=arguments[3];else throw Error("not a valid rectangle specification");return{left:a||0,top:c||0,width:b||0,height:d||0}}var c=f("./gamejs/utils/matrix"),k=f("./gamejs/utils/objects"),g=f("./gamejs/callback").Callback,a=["info","warn","error","fatal"],l=2;b.setLogLevel=function(c){if(typeof c==="string"&&a.indexOf(c))l=a.indexOf(c);else if(typeof c==="number")l=c;else throw Error("invalid logLevel ",c,
" Must be one of: ",a);return l};var j=b.log=function(){if(m.worker.inWorker===!0)m.worker._logMessage(arguments);else{var a=Array.prototype.slice.apply(arguments,[0]);a.unshift(Date.now());window.console!==void 0&&console.log.apply&&console.log.apply(console,a)}};b.info=function(){l<=a.indexOf("info")&&j.apply(this,arguments)};b.warn=function(){l<=a.indexOf("warn")&&j.apply(this,arguments)};b.error=function(){l<=a.indexOf("error")&&j.apply(this,arguments)};b.fatal=function(){l<=a.indexOf("fatal")&&
j.apply(this,arguments)};var e=b.Rect=function(){var a=d.apply(this,arguments);this.left=a.left;this.top=a.top;this.width=a.width;this.height=a.height;return this};k.accessors(e.prototype,{bottom:{get:function(){return this.top+this.height},set:function(a){this.top=a-this.height}},right:{get:function(){return this.left+this.width},set:function(a){this.left=a-this.width}},center:{get:function(){return[this.left+this.width/2|0,this.top+this.height/2|0]},set:function(){var a=d.apply(this,arguments);
this.left=a.left-this.width/2|0;this.top=a.top-this.height/2|0}},topleft:{get:function(){return[this.left,this.top]},set:function(){var a=d.apply(this,arguments);this.left=a.left;this.top=a.top}},bottomleft:{get:function(){return[this.left,this.bottom]},set:function(){var a=d.apply(this,arguments);this.left=a.left;this.bottom=a.top}},topright:{get:function(){return[this.right,this.top]},set:function(){var a=d.apply(this,arguments);this.right=a.left;this.top=a.top}},bottomright:{get:function(){return[this.right,
this.bottom]},set:function(){var a=d.apply(this,arguments);this.right=a.left;this.bottom=a.top}},x:{get:function(){return this.left},set:function(a){this.left=a}},y:{get:function(){return this.top},set:function(a){this.top=a}}});e.prototype.move=function(){var a=d.apply(this,arguments);return new e(this.left+a.left,this.top+a.top,this.width,this.height)};e.prototype.moveIp=function(){var a=d.apply(this,arguments);this.left+=a.left;this.top+=a.top};e.prototype.clip=function(a){if(!this.collideRect(a))return new e(0,
0,0,0);var c,b,d,j;if(this.left>=a.left&&this.left<a.right)c=this.left;else if(a.left>=this.left&&a.left<this.right)c=a.left;this.right>a.left&&this.right<=a.right?d=this.right-c:a.right>this.left&&a.right<=this.right&&(d=a.right-c);if(this.top>=a.top&&this.top<a.bottom)b=this.top;else if(a.top>=this.top&&a.top<this.bottom)b=a.top;this.bottom>a.top&&this.bottom<=a.bottom?j=this.bottom-b:a.bottom>this.top&&a.bottom<=this.bottom&&(j=a.bottom-b);return new e(c,b,d,j)};e.prototype.union=function(a){var c,
b;c=Math.min(this.left,a.left);b=Math.min(this.top,a.top);return new e(c,b,Math.max(this.right,a.right)-c,Math.max(this.bottom,a.bottom)-b)};e.prototype.inflate=function(a,c){var b=this.clone();b.inflateIp(a,c);return b};e.prototype.inflateIp=function(a,c){this.left-=Math.floor(a/2);this.top-=Math.floor(c/2);this.width+=a;this.height+=c};e.prototype.collidePoint=function(){var a=d.apply(this,arguments);return this.left<=a.left&&a.left<=this.right&&this.top<=a.top&&a.top<=this.bottom};e.prototype.collideRect=
function(a){return!(this.left>a.right||this.right<a.left||this.top>a.bottom||this.bottom<a.top)};e.prototype.collideLine=function(a,c){var b=a[0],d=a[1],e=c[0],j=c[1],g=!0,f=!0,l=!0;[[this.left,this.top],[this.left,this.bottom],[this.right,this.top],[this.right,this.bottom]].map(function(a){return(j-d)*a[0]+(b-e)*a[1]+(e*d-b*j)}).forEach(function(a){a>0?f=!1:a<0?g=!1:a===0&&(l=!1)},this);if((g||f)&&l)return!1;return!(b>this.right&&e>this.right||b<this.left&&e<this.left||d<this.top&&j<this.top||d>
this.bottom&&j>this.bottom)};e.prototype.toString=function(){return["[",this.left,",",this.top,"] [",this.width,",",this.height,"]"].join("")};e.prototype.clone=function(){return new e(this)};var n=b.Surface=function(){var a=d.apply(this,arguments),j=a.left,g=a.top;if(arguments.length==1&&arguments[0]instanceof e)j=a.width,g=a.height;this._matrix=c.identity();this._canvas=document.createElement("canvas");this._canvas.width=j;this._canvas.height=g;this._blitAlpha=1;this._context=this._canvas.getContext("2d");
b.display._isSmoothingEnabled()?this._smooth():this._noSmooth();return this};n.prototype._noSmooth=function(){this.context.mozImageSmoothingEnabled=!1;this.context.webkitImageSmoothingEnabled=!1};n.prototype._smooth=function(){this.context.mozImageSmoothingEnabled=!0;this.context.webkitImageSmoothingEnabled=!0};n.prototype.blit=function(a,b,d,j){if(b instanceof e){var b=b.clone(),g=a.getSize();if(!b.width)b.width=g[0];if(!b.height)b.height=g[1]}else b=b&&b instanceof Array&&b.length==2?new e(b,a.getSize()):
new e([0,0],a.getSize());j=j||"source-over";d instanceof e||(d&&d instanceof Array&&d.length==2?(g=a.getSize(),d=new e(d,[g[0]-d[0],g[1]-d[1]])):d=new e([0,0],a.getSize()));if(isNaN(b.left)||isNaN(b.top)||isNaN(b.width)||isNaN(b.height))throw Error("[blit] bad parameters, destination is "+b);this.context.save();this.context.globalCompositeOperation=j;j=c.translate(c.identity(),b.left,b.top);j=c.multiply(j,a._matrix);this.context.transform(j[0],j[1],j[2],j[3],j[4],j[5]);this.context.globalAlpha=a._blitAlpha;
this.context.drawImage(a.canvas,d.left,d.top,d.width,d.height,0,0,b.width,b.height);this.context.restore()};n.prototype.getSize=function(){return[this.canvas.width,this.canvas.height]};n.prototype.getRect=function(){return new e([0,0],this.getSize())};n.prototype.fill=function(a,c){this.context.save();this.context.fillStyle=a||"#000000";c===void 0&&(c=new e(0,0,this.canvas.width,this.canvas.height));this.context.fillRect(c.left,c.top,c.width,c.height);this.context.restore()};n.prototype.clear=function(a){var c=
this.getSize(),a=a||new e(0,0,c[0],c[1]);this.context.clearRect(a.left,a.top,a.width,a.height)};k.accessors(n.prototype,{rect:{get:function(){return this.getRect()}},context:{get:function(){return this._context}},canvas:{get:function(){return this._canvas}}});n.prototype.clone=function(){var a=new n(this.getRect());a.blit(this);return a};n.prototype.getAlpha=function(){return 1-this._blitAlpha};n.prototype.setAlpha=function(a){if(!isNaN(a)&&!(a<0||a>1))return this._blitAlpha=1-a,1-this._blitAlpha};
n.prototype.getImageData=function(){var a=this.getSize();return this.context.getImageData(0,0,a[0],a[1])};b.display=f("./gamejs/display");b.draw=f("./gamejs/draw");b.event=f("./gamejs/event");b.font=f("./gamejs/font");b.http=f("./gamejs/http");b.image=f("./gamejs/image");b.mask=f("./gamejs/mask");b.mixer=f("./gamejs/mixer");b.sprite=f("./gamejs/sprite");b.surfacearray=f("./gamejs/surfacearray");b.time=f("./gamejs/time");b.transform=f("./gamejs/transform");b.utils={arrays:f("./gamejs/utils/arrays"),
objects:f("./gamejs/utils/objects"),matrix:f("./gamejs/utils/matrix"),vectors:f("./gamejs/utils/vectors"),math:f("./gamejs/utils/math"),uri:f("./gamejs/utils/uri"),prng:f("./gamejs/utils/prng"),base64:f("./gamejs/utils/base64")};b.pathfinding={astar:f("./gamejs/pathfinding/astar")};b.worker=f("./gamejs/worker");b.xml=f("./gamejs/xml");b.tmx=f("./gamejs/tmx");b.noise=f("./gamejs/noise");var m=b,o={};b.ready=m.worker.inWorker===!0?function(a){f("./gamejs/worker")._ready();m.init();a()}:function(a){function c(){if(!document.body)return window.setTimeout(c,
50);e=m.image.preload(o);try{d=m.mixer.preload(o)}catch(a){m.debug("Error loading audio files ",a)}window.setTimeout(b,50)}function b(){if(e()<1||d()<1)return window.setTimeout(b,100);m.display.init();m.image.init();m.mixer.init();m.event.init();m.utils.prng.init();a()}var d=null,e=null;m.time.init();window.setTimeout(c,13);return function(){if(e)return 0.5*e()+0.5*d();return 0.1}};b.init=function(){var a={};["time","display","image","mixer","event"].forEach(function(c){try{m[c].init()}catch(b){a[c]=
b.toString()}});return a};b.preload=function(a){var c=f("./gamejs/utils/uri"),b=window.$g&&window.$g.resourceBaseHref||document.location.href;a.forEach(function(a){o[a]=c.resolve(b,a)},this)};b.onEvent=function(a,c){b.event._CALLBACK=new g(a,c)};b.onTick=function(a,c){b.time._CALLBACK=new g(a,c)}}},["gamejs/utils/matrix","gamejs/utils/objects","gamejs/callback","gamejs/display","gamejs/draw","gamejs/event","gamejs/font","gamejs/http","gamejs/image","gamejs/mask","gamejs/mixer","gamejs/sprite","gamejs/surfacearray",
"gamejs/time","gamejs/transform","gamejs/utils/arrays","gamejs/utils/vectors","gamejs/utils/math","gamejs/utils/uri","gamejs/utils/prng","gamejs/utils/base64","gamejs/pathfinding/astar","gamejs/worker","gamejs/xml","gamejs/tmx","gamejs/noise"]);
require.define({scenes:function(f,b){var d=f("gamejs"),c=f("./combatresolver").CombatResolver,k=f("gamejs/utils/vectors"),g=f("./viewport").ViewPort,a=f("./aidirector").AiDirector,l=f("./flockmanager").FlockManager;f("./mob");var j=f("./shop").Shop,e=f("./inputhandler").InputHandler;b.Game=function(b){this.handleEvent=function(a){z.handleEvent(a)};this.draw=function(a){a.blit(b.renderer.getSurface(),a.getRect(),t.rect);v.draw(a,t.rect);f.draw(a,t.rect);o.draw(a,t.rect);u.draw(a,t.rect);y.draw(a,t.rect);
p.draw(a,t.rect);!DEBUG&&t.draw(a);z.draw(a,t.rect);y.drawGui(a);v.drawGui(a,t.rect,s.rect);for(var c=[10,35],d=0;d<s.bombs;d++)a.blit(A.bomb,c),c=k.add(c,[17,0]);c=[10,55];for(d=0;d<s.coins;d++)a.blit(A.coin,c),c=k.add(c,[17,0]);DEBUG&&a.blit(B)};this.update=function(a){t.update(a,s.rect.center);u.update(a);p.update(a);f.update(a);o.update(a);y.update(a)&&v.nextShop();a=b.viewToMap(s.rect.topleft);a.reverse();v.contains(a)?v.show():v.hide()};var f=new d.sprite.Group,o=new d.sprite.Group,p=window.flockManager=
new l(f,o,b),q=b.getPosition(),r=p.createFriendlyFlock();r.center=q;r.type="captain";r.weapon="gauntling";q=p.addBoid(r);f.add(q);var s=window.player=f.sprites()[0];s.isPlayer=!0;s.inFlock=!0;s.coins=1;s.bombs=0;s.setDirection(null);r.isPlayer=!0;r.type="pirate";for(q=0;q<2;q++)f.add(p.addBoid(r));p.setPlayer(s);var u=new c(f,o,b),t=new g({mapSize:b.renderer.getSurface().getSize()}),r=Date.now(),y=new a(s,p,b);d.log("AiDirector spawn time ",Date.now()-r);var r=Date.now(),v=new j(s,p,f,b);d.log("Shop spawn time ",
Date.now()-r);var z=new e(s,u),A={coin:d.image.load("./images/coin.png"),bomb:d.image.load("./images/bomb_big.png")},B=b.renderer.getPreviewSurface();return this}}},["gamejs","combatresolver","gamejs/utils/vectors","viewport","aidirector","flockmanager","mob","shop","inputhandler"]);
require.define({coin:function(f,b){var d=f("gamejs"),c=f("./animation").Animation,k=f("gamejs/utils/vectors"),g=b.Coin=function(a){g.superConstructor.apply(this,arguments);this.radius=32;this.explosion=null;this.animation=new c({frameMs:100,spriteSheet:{image:"./images/coins.png",rows:1,cols:6,directions:{n:{animation:0}}}});this.animation.setDirection("n");this.rect=new d.Rect(a,this.animation.image.getSize());return this};d.utils.objects.extend(g,d.sprite.Sprite);g.prototype.draw=function(a,c){a.blit(this.animation.image,
k.subtract(k.subtract(this.rect.topleft,k.multiply(this.animation.image.getSize(),0.6)),c.topleft))};g.prototype.update=function(a){this.animation.update(a)}}},["gamejs","animation","gamejs/utils/vectors"]);
require.define({mob:function(f,b){var d=f("gamejs");f("gamejs/sprite");var c=f("gamejs/utils/objects"),k=f("gamejs/utils/vectors"),g=f("./animation").Animation,a=f("./muzzle").Muzzle,l=f("./sounds"),j=f("./prng"),e=b.Unit=function(c,b){e.superConstructor.apply(this,[]);this.moveVector=[0,0];this.animation=new g(b||{spriteSheet:{image:null,cols:null,rows:null,directions:null}});this.rect=new d.Rect(c,e.SIZE);this.muzzle=new a(this.rect);this.direction=null;this.setDirection("e");this.health=b.health||
1;this.radius=b.radius||15;this.speed=b.speed||60;e.shield=d.image.load("./images/shield.png");this.updateCountDown=0;return this};c.extend(e,d.sprite.Sprite);e.SIZE=[16,18];e.DIRECTIONS={n:{cartasian:[0,-1],angle:270},s:{cartasian:[0,1],angle:90},w:{cartasian:[-1,0],angle:180},e:{cartasian:[1,0],angle:0},nw:{cartasian:k.unit([-1,-1]),angle:225},ne:{cartasian:k.unit([1,-1]),angle:315},sw:{cartasian:k.unit([-1,1]),angle:135},se:{cartasian:k.unit([1,1]),angle:45}};e.getDirectionForVector=function(a){var c=
null,b=Infinity,a=k.multiply(a,-1),d;for(d in e.DIRECTIONS){var j=k.angle(e.DIRECTIONS[d].cartasian,a);j<b&&(b=j,c=d)}return c};e.prototype.getViewTiles=function(){var a=this.direction;a.length>1&&(a=a.substring(0,1));for(var c=this.getTilePos(),b=[],d=e.DIRECTIONS[a].cartasian,j=[0,0],j=["n","s"].indexOf(a)>-1?[1,0]:[0,1],a=6;a-- >0;)for(var c=k.add(c,d),g=-a;g<a+1;g++)b.push(k.add(k.multiply(j,g),c));return b};e.prototype.setDirection=function(a,c){if(a!==this.direction||c)a===null?this.moveVector=
[0,0]:(this.direction=a,this.muzzle.setDirection(a),this.animation.setDirection(a),this.moveVector=e.DIRECTIONS[a].cartasian)};e.prototype.update=function(a){this.muzzle.update(a);if(this.isPlayer===!0){if(this.updateControlled(a),this.inFlock)this.boid.pos=this.rect.center}else this.updateBoid(a)};e.prototype.updateBoid=function(a){this.rect.center=this.boid.pos;this.updateCountDown<=0?(this.direction=e.getDirectionForVector(this.boid.vel),this.muzzle.setDirection(this.direction),this.animation.setDirection(this.direction),
updateCountDown=800):updateCountDown-=a;this.animation.update(a);this.boid.flock.blackboard.state==="errorpath"&&(d.log("Errorpath suicide",this),this.kill())};e.prototype.updateControlled=function(a){if(!(k.len(this.moveVector)<=0.01)){this.animation.update(a);var c=this.moveVector[0]*(a/1E3)*this.speed,a=this.moveVector[1]*(a/1E3)*this.speed;this.boid.flock.chunk.isMoveable(k.add(this.rect.center,[c,a]))&&this.rect.moveIp(c,a)}};e.prototype.drawPlayer=function(a,c){if(this.isPlayer){var b=[255,
this.health*255|0,this.health*255|0];d.draw.circle(a,"rgb("+b[0]+","+b[1]+", "+b[2]+")",k.add(c,[this.rect.width/2,this.rect.height/2]),16,2)}else b=[255,this.health*510|0,this.health*510|0],d.draw.circle(a,"rgba("+b[0]+","+b[1]+", "+b[2]+",0.3)",k.add(c,[this.rect.width/2,this.rect.height/2]),15,0),this.boid.flock.blackboard.state==="guard"&&a.blit(e.shield,k.add(c,[16,5]))};e.prototype.draw=function(a,c){if(!c.collideRect(this.rect))return!1;var b=k.subtract(this.rect.topleft,c.topleft);this.boid.flock.isPlayer&&
this.drawPlayer(a,b);a.blit(this.animation.image,b);this.muzzle.draw(a,c)};e.prototype.getTilePos=function(){var a=k.divide(this.rect.center,16);return[a[0]|0,a[1]|0]};e.prototype.kill=function(){e.superClass.kill.apply(this,arguments);this.boid.isDead=!0;l.play("splash"+parseInt(4*j.random(),10));this.boid.flock.isPlayer?(this.isPlayer&&f("./stats").defeat(),f("./stats").count("friendly")):f("./stats").count("enemy")}}},["gamejs","gamejs/sprite","gamejs/utils/objects","gamejs/utils/vectors","animation",
"muzzle","sounds","prng","stats"]);
require.define({perlin:function(f,b){var d=b.SimplexNoise=function(c){c==void 0&&(c=Math);this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]];this.p=[];for(var b=0;b<256;b++)this.p[b]=Math.floor(c.random()*256);this.perm=[];for(b=0;b<512;b++)this.perm[b]=this.p[b&255];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],
[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]};d.prototype.dot=
function(c,b,d){return c[0]*b+c[1]*d};d.prototype.noise=function(c,b){var d,a,f;f=(c+b)*0.5*(Math.sqrt(3)-1);var j=Math.floor(c+f),e=Math.floor(b+f),n=(3-Math.sqrt(3))/6;f=(j+e)*n;d=c-(j-f);var m=b-(e-f),o,p;d>m?(o=1,p=0):(o=0,p=1);a=d-o+n;var q=m-p+n;f=d-1+2*n;var n=m-1+2*n,r=j&255;e&=255;j=this.perm[r+this.perm[e]]%12;o=this.perm[r+o+this.perm[e+p]]%12;p=this.perm[r+1+this.perm[e+1]]%12;e=0.5-d*d-m*m;e<0?d=0:(e*=e,d=e*e*this.dot(this.grad3[j],d,m));m=0.5-a*a-q*q;m<0?a=0:(m*=m,a=m*m*this.dot(this.grad3[o],
a,q));q=0.5-f*f-n*n;q<0?f=0:(q*=q,f=q*q*this.dot(this.grad3[p],f,n));return 70*(d+a+f)};d.prototype.noise3d=function(c,b,d){var a,f,j,e=(c+b+d)*(1/3),n=Math.floor(c+e),m=Math.floor(b+e),o=Math.floor(d+e),e=1/6;j=(n+m+o)*e;a=c-(n-j);f=b-(m-j);var p=d-(o-j),q,r,s,u,t,y;a>=f?f>=p?(q=1,s=r=0,t=u=1,y=0):(a>=p?(q=1,s=r=0):(r=q=0,s=1),u=1,t=0,y=1):f<p?(r=q=0,s=1,u=0,y=t=1):a<p?(q=0,r=1,u=s=0,y=t=1):(q=0,r=1,s=0,t=u=1,y=0);var v=a-q+e,z=f-r+e,A=p-s+e;j=a-u+2*e;var c=f-t+2*e,B=p-y+2*e,d=a-1+3*e,b=f-1+3*e,
e=p-1+3*e;n&=255;var D=m&255,C=o&255,m=this.perm[n+this.perm[D+this.perm[C]]]%12,o=this.perm[n+q+this.perm[D+r+this.perm[C+s]]]%12;u=this.perm[n+u+this.perm[D+t+this.perm[C+y]]]%12;n=this.perm[n+1+this.perm[D+1+this.perm[C+1]]]%12;t=0.6-a*a-f*f-p*p;t<0?a=0:(t*=t,a=t*t*this.dot(this.grad3[m],a,f,p));f=0.6-v*v-z*z-A*A;f<0?f=0:(f*=f,f=f*f*this.dot(this.grad3[o],v,z,A));v=0.6-j*j-c*c-B*B;v<0?j=0:(v*=v,j=v*v*this.dot(this.grad3[u],j,c,B));c=0.6-d*d-b*b-e*e;c<0?d=0:(c*=c,d=c*c*this.dot(this.grad3[n],d,
b,e));return 32*(a+f+j+d)}}},[]);
require.define({world:function(f,b){var d=f("gamejs"),c=f("gamejs/utils/vectors"),k=f("./perlin").SimplexNoise,g=f("./spritesheet").SpriteSheet,a=f("gamejs/pathfinding/astar"),l=f("./prng"),j=[{factor:1/30,weight:0.7},{factor:1/30,weight:0.3},{factor:1/15,weight:0}],e={0:4,2:1,4:3,8:5,16:7,18:4,12:4,6:0,14:1,10:2,22:3,30:4,26:5,20:6,28:7,24:8},n=[140,140],m=[{max:40,name:"water",posMapping:e,color:"#0000ff"},{max:50,name:"sand",posMapping:e,color:"#ffff00"},{max:51,name:"sandwoods",posMapping:e,color:"#ffcc00"},
{max:60,name:"sand",posMapping:e,color:"#ffff00"},{max:80,name:"dirt",posMapping:e,color:"#bab5ab"},{min:80,max:160,name:"gras",posMapping:e,color:"#267726"},{max:190,name:"woods",posMapping:e,color:"#884631"},{max:230,name:"hills",posMapping:e,color:"#565248"},{max:255,name:"mountains",posMapping:e,color:"#000000"},{max:257,name:"bricks",posMapping:{0:4,2:3,4:0,8:0,16:3,18:3,12:0,6:5,14:4,10:4,22:4,26:4,20:0,28:0,24:0,30:4},color:"#df421e"},{min:258,max:266,name:"extras",color:"#ff3399"},{max:268,
name:"crater",posMapping:e,color:"#330066"}],o=b.Map=function(){this.getChunk=function(a){return new q(a,n)};return this};o.getRangeForN=function(a){var c=null;m.some(function(b){c=b;if(a<=b.max)return!0;return!1});return c};var p=b.ChunkRenderer=function(a){m=m.map(function(a){a.sheet=new g({image:"./images/terrain/"+a.name+".png",cols:3,rows:3});return a});var b={2:[0,1],4:[1,0],8:[-1,0],16:[0,-1]},e=function(c,e,j){var f=a.data[e][j],g=o.getRangeForN(f),l=[e*16,j*16];if(g.name==="extras")c.blit(g.sheet.get(f-
g.min),l);else{var k,e=[e,j],j=0;for(k in b){var m=b[k];k|=0;var n=e[0]+m[0],m=e[1]+m[1];if(n<0||m<0||n>a.data.length-1||m>a.data[0].length-1)j+=k;else if(n=o.getRangeForN(a.data[n][m]),n.name===g.name||g.name==="sand"&&(n.name==="water"||n.name==="sandwoods")||n.name==="extras"||n.name==="crater")j+=k}k=g.sheet.get(g.posMapping[j]);c.blit(k,l);g.name==="gras"&&(f=(f-g.min)/(g.max-g.min),g=new d.Surface([16,16]),g.fill("rgba(0, 255, 0, "+(1-f)*0.4+")"),c.blit(g,l))}};this.getSurface=function(){if(this.surface)return this.surface;
this.surface=new d.Surface(c.multiply(a.dimensions,16));for(var b=0;b<a.dimensions[0];b++)for(var j=0;j<a.dimensions[1];j++)e(this.surface,b,j);return this.surface};this.getPreviewSurface=function(){for(var b=new d.Surface(c.multiply(a.dimensions,3)),e=new d.Rect([0,0],[3,3]),j=0;j<a.dimensions[0];j++)for(var f=0;f<a.dimensions[1];f++){var g=o.getRangeForN(a.data[j][f]);e.topleft=[j*3,f*3];d.draw.rect(b,g.color,e,0)}return b};this.redraw=function(c){if(c.left<0)c.left=0;if(c.top<0)c.top=0;if(c.right>
a.dimensions[0])c.right=a.dimensions[0];if(c.bottom>a.dimensions[1])c.bottom=a.dimensions[1];for(var b=c.left;b<c.right;b++)for(var d=c.top;d<c.bottom;d++)e(this.getSurface(),b,d)};this.addBlood=function(a){var c=this.getSurface(),b=l.random()*9|0;c.blit(j.get(b),a)};var j=new g({image:"./images/blood.png",cols:2,rows:5});return this},q=b.Chunk=function(a,c,b,e){this.topleft=a;this.dimensions=c;this.aiZoom=this.viewZoom=1;this.data=b||this.generate(this.viewZoom);this.bases=e||this.spawnBases();this.astarMap=
new s(this.data);if(!d.worker.inWorker)this.renderer=new p(this);return this};q.load=function(a){return new q(a.topleft,a.dimensions,a.data,a.bases)};q.prototype.save=function(){return{topleft:this.topleft,dimensions:this.dimensions,data:this.data,bases:this.bases}};q.prototype.generate=function(a,b){for(var b=b||1,e=new k(l),f=Date.now(),g=[],m=this.topleft[0];m<this.dimensions[0]*b;m++){for(var n=[],o=this.topleft[1];o<this.dimensions[1]*b;o++){var p=0;j.forEach(function(c){noise=e.noise(m*c.factor*
a,o*c.factor*a)*c.weight;p+=noise},this);p=parseInt(127.5+p*127.5,10);n.push(p)}g.push(n)}for(var n=c.divide(this.dimensions,2),q=Math.max(this.dimensions[0],this.dimensions[1])*0.4,s=Math.pow(q,2),m=this.topleft[0];m<this.dimensions[0]*b;m++)for(o=this.topleft[1];o<this.dimensions[1]*b;o++)if(m<this.topleft[0]+3||o<this.topleft[1]+3||m>this.dimensions[0]*b-3||o>this.dimensions[1]*b-3)g[m][o]=0;else{var r=Math.pow(q,2)-(Math.pow(m-n[0],2)+Math.pow(o-n[1],2));r/=s;r>0&&(r=0);g[m][o]+=r*128}d.info("Chunk",
this.topleft,this.dimensions,"generated in",Date.now()-f," ms");return g};var r=[[0,0,259,259,259,0,0],[0,0,259,259,259,0,0],[259,0,0,259,0,0,259],[0,259,0,0,0,259,0],[0,0,259,0,259,0,0],[0,0,0,259,0,0,0],[0,0,259,0,259,0,0],[0,0,259,0,259,0,0],[0,0,259,0,259,0,0],[0,259,259,0,259,259,0]];q.prototype.spawnBases=function(){for(var a=[],b=this.getSpiralPosGenerator(),d=0;d<3;d++){var e=b();r.forEach(function(a,b){a.forEach(function(a,d){a!==0&&this.modify(this.viewToMap(c.add(e,[b*16,d*16])),a,!0)},
this)},this);a.push({pos:e,isDead:!1})}return a};q.prototype.findRoute=function(b,e,j){for(var b=this.viewToAiMap(b),e=this.viewToAiMap(e),f=Date.now(),j=a.findRoute(this.astarMap,b,e,j||50),g=[];j;)g.push(j.point),j=j.from;g.reverse();d.info("Findroute from",b,"to",e,"with length",g.length,"generated in",Date.now()-f," ms");return g.filter(function(a,c){return c%4===0||c===g.length-1||c<3},this).map(function(a){return c.multiply(a,16*(this.aiZoom/this.viewZoom))},this)};q.prototype.isMoveable=function(a){a=
[a[0]/16|0,a[1]/16|0];if(a[0]<0||a[0]>this.data.length-1||a[1]<0||a[1]>this.data[0].length-1)return!1;return["sand","gras","dirt","crater"].indexOf(o.getRangeForN(this.data[a[0]][a[1]]).name)>-1};q.prototype.viewToAiMap=function(a){return[a[0]/(16*(this.aiZoom/this.viewZoom))|0,a[1]/(16*(this.aiZoom/this.viewZoom))|0]};q.prototype.viewToMap=function(a){return a=[a[1]/16|0,a[0]/16|0]};q.prototype.mapToView=function(a){return a=[a[0]*16,a[1]*16]};q.prototype.modify=function(a,b,e){if(!(a[0]<0)&&!(a[1]<
0)&&!(a[0]>=this.dimensions[0])&&!(a[1]>=this.dimensions[1]))return this.data[a[0]][a[1]]=b,a=new d.Rect(c.subtract(a,[5,5]),[10,10]),e!==!0&&this.renderer.redraw(a),a};q.prototype.getPosition=function(a,b,d){for(var e=c.multiply(this.dimensions,16),j=a&&a.slice(0)||[l.rand(e[0]*0.2,e[0]*0.8),l.rand(e[1]*0.2,e[1]*0.8)],b=Math.min(b||e[0]/2,j[0],j[1],e[0]-j[0],e[1]-j[1]),f=j.slice(0),g=0;!this.isMoveable(f)&&g<200;)f=c.add(j,[l.rand(-b,b),l.rand(-b,b)]),g++,g>=200&&a===void 0&&(j=[l.rand(e[0]*0.2,
e[0]*0.8),l.rand(e[1]*0.2,e[1]*0.8)],g=0);if(g===200&&!d)return null;return f};q.prototype.getSpiralPosGenerator=function(){var a=this,b=l.rand(100,200),d=c.multiply(a.dimensions,8),e=function(){e.idx++;var j=c.add(d,[1*Math.pow(e.idx*b,1)*Math.cos(e.idx*b),1*Math.pow(e.idx*b,1)*Math.sin(e.idx*b)]);return a.getPosition(j)};e.idx=1;return e};var s=b.AChunk=function(a){this.data=a;return this};s.prototype.adjacent=function(a){for(var b=[],d=-1;d<2;d++)for(var e=-1;e<2;e++){var j=c.add(a,[d,e]);this.isMoveable(j)&&
b.push(j)}return b};s.prototype.isMoveable=function(a){if(a[0]<0||a[0]>this.data.length-1||a[1]<0||a[1]>this.data[0].length-1)return!1;return["water","hills","mountains","woods","sandwoods"].indexOf(o.getRangeForN(this.data[a[0]][a[1]]).name)==-1};s.prototype.equals=function(a,c){return a[0]===c[0]&&a[1]===c[1]};s.prototype.estimatedDistance=function(a,b){return c.distance(a,b)};s.prototype.actualDistance=function(a,b){var d=this.data[a[0]][a[1]],e=this.data[b[0]][b[1]],j=c.distance(a,b);if(d>e)return j/
100;if(d<e)return j*100;return j};s.prototype.hash=function(a){return a[0]+"/"+a[1]}}},["gamejs","gamejs/utils/vectors","perlin","spritesheet","gamejs/pathfinding/astar","prng"]);
require.define({inputhandler:function(f,b){var d=f("gamejs"),c=f("gamejs/utils/vectors");b.InputHandler=function(b,f){var a={},l=function(c){a[d.event.K_LEFT]&&a[d.event.K_UP]||a[d.event.K_a]&&a[d.event.K_w]?c.setDirection("nw",!0):a[d.event.K_RIGHT]&&a[d.event.K_UP]||a[d.event.K_d]&&a[d.event.K_w]?c.setDirection("ne",!0):a[d.event.K_LEFT]&&a[d.event.K_DOWN]||a[d.event.K_a]&&a[d.event.K_s]?c.setDirection("sw",!0):a[d.event.K_RIGHT]&&a[d.event.K_DOWN]||a[d.event.K_d]&&a[d.event.K_s]?c.setDirection("se",
!0):a[d.event.K_LEFT]||a[d.event.K_a]?c.setDirection("w",!0):a[d.event.K_RIGHT]||a[d.event.K_d]?c.setDirection("e",!0):a[d.event.K_UP]||a[d.event.K_w]?c.setDirection("n",!0):a[d.event.K_DOWN]||a[d.event.K_s]?c.setDirection("s",!0):c.setDirection(null)},j=function(){var a=Date.now()-e;return Math.min(1,a/1E3*0.6+0.4)},e=null,n=null;this.handleEvent=function(o){if(o.type===d.event.KEY_DOWN)a[o.key]=!0,l(b),!e&&o.key===d.event.K_SPACE&&(e=Date.now());else if(o.type==d.event.KEY_UP){if(a[o.key]=!1,l(b),
o.key===d.event.K_SPACE&&(Date.now()-n>1E3&&b.bombs>0&&(f.addBomb({pos:b.rect.center,xDir:["w","sw","nw"].indexOf(b.direction)>-1?-1:1,launchVelocity:j()}),b.bombs--),n=e=null),o.key===d.event.K_SHIFT)b.inFlock=!b.inFlock,b.inFlock?b.boid.flock.blackboard.state="following":(o=b.boid.flock,o.blackboard.state="guard",o.blackboard.target=o.center),b.boid.speed=b.boid.speed?0:b.speed}else o.type!==d.event.MOUSE_DOWN&&o.type===d.event.MOUSE_UP&&o.button===1&&window.flockManager.createEnemyFlock({type:"skull",
pos:c.add(o.pos,m.topleft),target:b.rect.center})};var m=null;this.draw=function(a,f){m=f;if(e&&b.bombs>0){var g=new d.Rect(c.subtract(b.rect.topleft,f.topleft),[5,20]);g.moveIp(-6,0);g.height=20*j();g.topleft=[g.topleft[0],g.topleft[1]-(g.height-20)];d.draw.rect(a,"rgba(50, 50, 50, 1)",g,0)}};return this}}},["gamejs","gamejs/utils/vectors"]);
require.define({explosion:function(f,b){var d=f("gamejs"),c=f("gamejs/utils/vectors"),k=f("./particles"),g=f("./prng"),a=b.Explosion=function(b,j,e){a.superConstructor.apply(this,[]);this.age=0;this.parts=[];for(var f=b.getSize(),m=0;m<f[0];){w=g.rand(a.MIN_SIZE,a.MAX_SIZE);for(var o=0;o<f[1];){h=g.rand(a.MIN_SIZE,a.MAX_SIZE);var p=new d.Surface(w,h);p.blit(b,new d.Rect(0,0,w,h),new d.Rect(m,o,w,h));this.parts.push({rect:new d.Rect(c.add(j,[m,o]),[w,h]),image:p,v:c.unit(c.add(e,[g.rand(-0.5,0.5),
g.rand(-0.5,0.5)]))});o+=h}m+=w}this.explosion=new k.Emitter({delay:50,numParticles:40,modifierFunc:k.Modifiers.explosion(10,0.5,"rgba(255,0,0,0.6)")});this.explosion.pos=j;this.explosion.start();return this};d.utils.objects.extend(a,d.sprite.Sprite);a.prototype.update=function(b){this.explosion.update(b);this.parts.forEach(function(d){d.rect.center=c.add(d.rect.center,c.multiply(d.v,b/1E3*a.SPEED));d.rect.width*=1-b/1E3*a.SIZE_DECREASE;d.rect.height*=1-b/1E3*a.SIZE_DECREASE});this.age+=b;this.age>
a.LIFETIME?(this.explosion.stop(),this.explosion=null,this.kill()):this.age>a.EMITTER_LIFETIME&&this.explosion.stop()};a.SPEED=150;a.MIN_SIZE=2;a.MAX_SIZE=10;a.LIFETIME=500;a.EMITTER_LIFETIME=100;a.SIZE_DECREASE=0.8;a.prototype.draw=function(a,c){this.explosion.draw(a,c);this.parts.forEach(function(b){var d=c.topleft;a.blit(b.image,b.rect.move(-d[0],-d[1]))})}}},["gamejs","gamejs/utils/vectors","particles","prng"]);
require.define({director:function(f,b){f("gamejs");b.Director=function(){var b=!1,c=null;this.draw=function(f){b&&c&&c.draw(f)};this.update=function(f){b&&c&&typeof c.update==="function"&&c.update(f)};this.handle=function(f){b&&c&&typeof c.handleEvent==="function"&&c.handleEvent(f)};this.start=function(c){this.replaceScene(c)};this.replaceScene=function(b){c=b};this.getScene=function(){return c};this.setOffAir=function(){b=!1};this.setOnAir=function(){b=!0};this.isOnAir=function(){return b};return this}}},
["gamejs"]);
require.define({particles:function(f,b){function d(){this.id=g+=1;this.colour="#ff0000";this.pos=[0,0];this.vY=this.vX=0;this.radius=1;this.createdAt=(new Date).getTime();this.life=Math.floor(Math.random()*300+1);this.friction=0.96;this.maxStopSize=0.4;this.slowThreshold=0.6;this.lastScaledAvgVel=0;this.isAlive=function(a){return this.life&&a-this.createdAt<this.life*1E3};this.update=function(){var c=this.pos[0],b=this.pos[1],d=this.vX,f=this.vY;d*=this.friction;f*=this.friction;var g=Math.abs(d),
l=Math.abs(f);g<this.slowThreshold&&(d*=Math.random()*2+0.2);l<this.slowThreshold&&(f*=Math.random()*2+0.2);this.lastScaledAvgVel=(g+l)*0.5*a;this.vX=d;this.vY=f;this.pos=[c+d,b+f]};this.draw=function(a,b){c.draw.circle(a,this.colour,[this.pos[0]-b.topleft[0],this.pos[1]-b.topleft[1]],Math.max(Math.min(this.lastScaledAvgVel,9.5),this.maxStopSize),0)};return this}var c=f("gamejs"),k=f("gamejs/utils/objects"),g=0,a=0.5,l=b.Emitter=function(a){this.options=a||{};this.pos=[0,0];this.delay=a.delay;this.numParticles=
a.numParticles;this.modifier=a.modifierFunc||function(){};this.initialize.call(this,a);this.particles=[];return this};l.prototype={intervalId:null,name:"bob",initialize:function(){},start:function(){var a=this;this.intervalId=setInterval(function(){l.createParticleSet.call(a,a.pos,a.numParticles,a.modifier)},this.delay);return this},stop:function(){clearInterval(this.intervalId);this.intervalId=null},update:function(a){var c=Date.now(),b=[];k.keys(this.particles).forEach(function(d){d=this.particles[d];
d.isAlive(c)?d.update(a):b.push(d.id)},this);this.removeDeadParticles(b)},draw:function(a,c){k.keys(this.particles).forEach(function(b){this.particles[b].draw(a,c)},this)},isRunning:function(){},createParticle:function(a,c){var b=new d;b.pos=a.slice(0);var f={xVel:void 0,yVel:void 0,life:b.life};c&&(f=c(b));if(typeof f.xVel=="undefined")f.xVel=Math.random()*4;if(typeof f.yVel=="undefined")f.yVel=Math.random()*4;b.vX=f.xVel;b.vY=f.yVel;b.life=f.life||b.life;b.colour=f.colour||b.colour;return this.particles[b.id]=
b},removeDeadParticles:function(a){for(var c=0;c<a.length;c++)delete this.particles[a[c]]}};l.createParticleSet=function(a,c,b){typeof c==="function"&&(b=c,c=null);for(var d=[],f=0;f<c;f++){var g=this.createParticle(a,b);d.push(g)}return d};b.Modifiers={ring:function(a,c,b){a=a||15;return function(d){return{xVel:Math.cos(d.id)*a,yVel:Math.sin(d.id)*a,life:c||0.6,colour:b}}},explosion:function(a,c,b){return function(d){a=a||20;return{xVel:Math.cos(d.id)*Math.random()*a,yVel:Math.sin(d.id)*Math.random()*
a,life:c||1,colour:b}}},tail:function(a,c,b,d){a=a||15;return function(){return{xVel:d[0]*a+Math.random()*a/4,yVel:d[1]*a+Math.random()*a/4,life:c||1.4,colour:b}}}}}},["gamejs","gamejs/utils/objects"]);
require.define({animation:function(f,b){var d=f("./spritesheet").SpriteSheet,c=b.Animation=function(b){this.sheet=new d(b.spriteSheet);this.directions=b.spriteSheet&&b.spriteSheet.directions;this.frameMs=b.frameMs||c.FRAME_MS;this.steps=b&&b.spriteSheet&&b.spriteSheet.cols-1||2;this.step=this.animation=0;this.countDown=this.frameMs;this.image=this.sheet.get(this.step,this.direction);this.direction=null;return this};c.FRAME_MS=250;c.prototype.setDirection=function(c){if(!this.direction||this.direction!==
c)this.animation=this.directions[c].animation,this.countDown=0,this.update(0),this.direction=c};c.prototype.update=function(c){this.countDown-=c;if(this.countDown<=0){this.countDown=this.frameMs;this.step++;if(this.step>this.steps)this.step=0;this.image=this.sheet.get(this.step,this.animation)}}}},["spritesheet"]);
require.define({stats:function(f,b){var d={coin:0,enemy:0,pirate:0,wave:0,friendly:0},c=Date.now(),k=document.getElementById("km-end");b.count=function(a){d[a]++};var g=function(){isShow=!0;var a=Date.now()-c,b=a/1E3/60|0,a=Math.round(a/1E3%60),b=(b+"").length<2?"0"+b:b,a=(a+"").length<2?"0"+a:a;d.time=b+":"+a;console.log("counters is ",d);for(var f in d)document.getElementById("km-end-"+f).textContent=d[f];k.style.display="block"};window.victory=b.victory=function(){document.getElementById("km-end-victory").style.display=
"block";g()};b.defeat=function(){document.getElementById("km-end-defeat").style.display="block";g()}}},[]);
require.define({projectile:function(f,b){var d=f("gamejs"),c=f("gamejs/utils/vectors"),k=f("./mob").Unit,g=f("./animation").Animation,a=b.Projectile=function(b){a.superConstructor.apply(this,arguments);this.vel=c.unit(c.subtract(b.destination,b.origin));this.radius=8;this.animation=new g({spriteSheet:{image:"./images/fireball.png",cols:8,rows:8,directions:a.DIRECTIONS}});this.animation.setDirection(k.getDirectionForVector(this.vel));this.rect=new d.Rect([0,0],this.animation.image.getSize());this.rect.center=
b.origin;this.countdown=1500;return this};d.utils.objects.extend(a,d.sprite.Sprite);a.prototype.isArmed=function(){return this.countdown<800};a.prototype.draw=function(a,b){a.blit(this.animation.image,c.subtract(this.rect.topleft,b.topleft))};a.prototype.update=function(b){this.countdown-=b;this.countdown<=0&&this.kill();this.rect.moveIp(c.multiply(this.vel,b/1E3*a.SPEED));this.animation.update(b)};a.SPEED=200;a.DIRECTIONS={w:{animation:0},nw:{animation:1},n:{animation:2},ne:{animation:3},e:{animation:4},
se:{animation:5},s:{animation:6},sw:{animation:7}}}},["gamejs","gamejs/utils/vectors","mob","animation"]);require.define({sounds:function(f,b){var d=f("gamejs");b.play=function(c){k[c].play()};var c=["gauntling","splash0","splash1","splash2","splash3","splash4","money","eruption","bomb","clock"],k=[];b.getPreloadAssets=function(){return c.map(function(c){return"./sounds/"+c+".wav"})};b.init=function(){c.forEach(function(c){k[c]=new d.mixer.Sound("./sounds/"+c+".wav")})}}},["gamejs"]);
require.define({bomb:function(f,b){var d=f("gamejs"),c=f("gamejs/utils/vectors");f("./particles");var k=f("./animation").Animation,g=b.Bomb=function(a){g.superConstructor.apply(this,[]);g.IMAGE=d.image.load("./images/bomb.png");this.image=g.IMAGE.clone();this.rect=new d.Rect(a.pos,this.image.getSize());this.xDir=a.xDir||1;this.time=0;this.launchVelocity=a.launchVelocity*150||150;this.origCenter=this.rect.center.slice(0);this.height=null;this.mass=10;this.explosion=null;this.animation=new k({spriteSheet:{image:"./images/explosion.png",
rows:1,cols:2,directions:{n:{animation:0},s:{animation:2},w:{animation:3},e:{animation:1},nw:{animation:3},ne:{animation:1},sw:{animation:3},se:{animation:1}}}});this.radius=40;this.animation.setDirection("n");this.dying=!1;this.age=400;return this};d.utils.objects.extend(g,d.sprite.Sprite);g.prototype.draw=function(a,b){if(!b.collideRect(this.rect))return!1;this.dying===!0?a.blit(this.animation.image,c.subtract(c.subtract(this.rect.topleft,c.multiply(this.animation.image.getSize(),0.6)),b.topleft)):
a.blit(this.image,c.subtract(this.rect.topleft,b.topleft))};g.prototype.update=function(a){if(this.dying)return this.age-=a,this.animation.update(a),this.age<=0&&this.kill(),!1;this.height=this.origCenter[1]-this.rect.center[1];if(this.time>500&&this.height<=0)return this.dying=!0;this.time+=a;a=this.time/1E3;this.rect.center=c.add(this.origCenter,[this.xDir*a*this.launchVelocity,-(a*this.launchVelocity+-10.4*this.mass*Math.pow(a,2))]);return!1}}},["gamejs","gamejs/utils/vectors","particles","animation"]);
require.define({"workers/chunk":function(f){var b=f("../world"),d=f("gamejs");d.ready(function(){d.onEvent(function(){var c=(new b.Map).getChunk([0,0]);d.worker.post({chunk:c.save()})})})}},["world","gamejs"]);
require.define({"workers/astar":function(f){var b=f("gamejs"),d=f("gamejs/pathfinding/astar"),c=f("../world").AChunk,k=f("gamejs/utils/vectors");self.achunk=null;var g=function(a){if(a.type==="mapdata")self.achunk=new c(a.map);else if(a.type==="findRoute"){for(var f=Date.now(),g=d.findRoute(self.achunk,a.origin,a.destination,12E4),e=[];g;)e.push(g.point),g=g.from;e.reverse();e=e.map(function(a){return a=k.multiply(a,16)}).filter(function(a,c){return c<1||c===e.length-1||c%6===0});b.worker.post({route:e.splice(0),
id:a.id,duration:Date.now()-f})}};b.ready(function(){b.onEvent(g)})}},["gamejs","gamejs/pathfinding/astar","world","gamejs/utils/vectors"]);
require.define({viewport:function(f,b){var d=f("gamejs"),c=f("gamejs/utils/vectors"),k=b.ViewPort=function(b){var a={direction:null,countdown:0,active:!1},f=k.FOG_COUNTDOWN;this.update=function(d,n){f-=d;if(f<0)this.fogOfWar.blit(j,c.subtract(n,c.divide(j.getSize(),2)),[0,0],"destination-out"),f=k.FOG_COUNTDOWN;if(a.active==!1&&c.distance(n,this.rect.center)>100)a.direction=c.unit(c.subtract(n,this.rect.center)),a.countdown=1200,a.active=!0;else if(a.active===!0){a.countdown-=d;var m=c.multiply(a.direction,
d/1E3*130);this.rect.center=c.add(this.rect.center,m);if(a.countdown<=0)a.active=!1;if(this.rect.left<0)this.rect.left=0;if(this.rect.top<0)this.rect.top=0;if(this.rect.right>b.mapSize[0])this.rect.right=b.mapSize[0];if(this.rect.bottom>b.mapSize[1])this.rect.bottom=b.mapSize[1]}};this.draw=function(a){a.blit(this.fogOfWar,c.multiply(this.rect.topleft,-1))};this.rect=new d.Rect([DISPLAY_DIMS[0]/2,DISPLAY_DIMS[1]/2],DISPLAY_DIMS);this.fogOfWar=new d.Surface(b.mapSize);this.fogOfWar.fill("black");var j=
d.image.load("./images/lightcone.png");return this};k.FOG_COUNTDOWN=200}},["gamejs","gamejs/utils/vectors"]);
require.define({combatresolver:function(f,b){var d=f("gamejs"),c=f("gamejs/utils/vectors"),k=f("./particles"),g=f("./explosion").Explosion,a=f("bomb").Bomb,l=f("./projectile").Projectile,j=f("./sounds"),e=f("./prng"),n=b.CombatResolver=function(b,f,p){this.enemies=f;this.friendlies=b;this.countdowns={};for(var q in n.COUNTDOWNS)this.countdowns[q]=n.COUNTDOWNS[q];var r=[],s=new d.sprite.Group,u=new d.sprite.Group,t=new d.sprite.Group,y=function(a,c){var b=[];c.forEach(function(c){a.forEach(function(a){var d=
a.getTilePos();d[0]===c[0]&&d[1]===c[1]&&b.push(a)})},this);return b};this.draw=function(a,c){u.draw(a,c);r.forEach(function(b){b.emitter.draw(a,c)});t.draw(a,c);s.draw(a,c)};this.addBomb=function(c){u.add(new a(c))};var v=function(a,b,f){if(a.boid){var j=c.subtract(a.boid.pos,f);if(p.isMoveable(j))a.boid.pos=j,a.rect.center=c.subtract(a.rect.center,f)}a.health-=b;a.health>0?(f=new k.Emitter({delay:90,numParticles:5,modifierFunc:k.Modifiers.explosion(4,1.2)}),f.pos=a.rect.center,f.start(),r.push({emitter:f,
age:0})):(b=a.animation.image,b=d.transform.scale(b,c.multiply(b.getSize(),1.8)),s.add(new g(b,a.rect.topleft,c.multiply(c.unit(f),-1))),a.kill(),e.random()<0.3&&p.renderer.addBlood(a.rect.center))},z={melee:function(a,b){d.sprite.groupCollide(a,b,!1,!1,d.sprite.collideCircle).forEach(function(a){var b=a.b;if(a.a.boid.flock.weapon!=="melee")return!1;a=c.unit(c.subtract(a.a.rect.center,b.rect.center));a=c.multiply(a,7);v(b,0.01,a);d.info("friendly melee hit",b.health)})},gauntling:function(a,b){a.forEach(function(a){if(a.boid&&
a.boid.flock.weapon!=="gauntling")return!1;var e=a.getViewTiles(),e=y(b,e);e.length>0?(d.utils.arrays.shuffle(e),a.muzzle.active||j.play("gauntling"),a.muzzle.active=!0,e.slice(0,3).forEach(function(b){var d=c.unit(c.subtract(a.rect.center,b.rect.center)),d=c.multiply(d,10);v(b,0.02,d)})):a.muzzle.active=!1})},projectile:function(a,b){a.forEach(function(a){if(!a.boid||a.boid.flock.weapon!=="projectile")return!1;var e=d.sprite.spriteCollide({rect:a.rect,radius:250},b,!1,d.sprite.collideCircle);if(e.length)d.utils.arrays.shuffle(e),
e.some(function(b){if(!c.distance(b.rect.center,a.rect.center)>200)return!1;t.add(new l({origin:a.rect.center,destination:b.rect.center}));return!0});else if(a.flock&&a.flock.blackboard)a.flock.blackboard.state="stopped"})}};this.update=function(b){u.forEach(function(a){if(a.update(b)){j.play("bomb");var e=d.sprite.spriteCollide(a,this.enemies,!1,d.sprite.collideCircle),e=e.concat(d.sprite.spriteCollide(a,this.friendlies,!1,d.sprite.collideCircle));e.forEach(function(b){var d=c.unit(c.subtract(a.rect.center,
b.rect.center)),d=c.multiply(d,15);v(b,0.2,d)},this);e=p.viewToMap(a.rect.center);e.reverse();for(var f=-3;f<3;f++)for(var g=-3;g<3;g++){var l=c.add(e,[f,g]);p.modify(l,267,!0)}p.modify(e,267)}},this);t.forEach(function(b){if(b.isArmed()){var c=d.sprite.spriteCollide(b,this.enemies,!1,d.sprite.collideCircle),c=c.concat(d.sprite.spriteCollide(b,this.friendlies,!1,d.sprite.collideCircle));c.some(function(){var c=new a({pos:b.rect.center,launchVelocity:1});c.time=Infinity;u.add(c);b.kill();return!0})}},
this);r=r.filter(function(a){a.age+=b;if(a.age>400)return a.emitter.stop(),a.emitter=null,!1;a.emitter.update(b);return!0});s.update(b);t.update(b);for(var e in n.COUNTDOWNS)if(this.countdowns[e]-=b,this.countdowns[e]<=0){if(e!=="melee")z[e](this.friendlies,this.enemies);z[e](this.enemies,this.friendlies);this.countdowns[e]=n.COUNTDOWNS[e]}};return this};n.COUNTDOWNS={gauntling:200,projectile:2E3,melee:300}}},["gamejs","gamejs/utils/vectors","particles","explosion","bomb","projectile","sounds","prng"]);
require.define({spritesheet:function(f,b){var d=f("gamejs");b.SpriteSheet=function(b){this.get=function(){var a=null;if(arguments.length===2){var a=arguments[0],b=arguments[1];a+=b*l}else arguments.length===1&&arguments[0]instanceof Array?(a=arguments[0][0],b=arguments[0][1],a+=b*l):arguments.length===1&&(a=arguments[0]);if(a<n.length)return n[a]};var f=b.width,g=b.height,a=b.rows,l=b.cols,j=b.margin||0,e=d.image.load(b.image);f||(f=parseInt((e.rect.width-j*l)/b.cols,10),g=parseInt((e.rect.height-
j*a)/b.rows,10));l||(a=(e.rect.width-j*l)/f,l=(e.rect.height-j*l)/g);for(var n=[],b=j;b<e.rect.height;b+=g+j)for(a=j;a<e.rect.width;a+=f+j){var m=new d.Surface([f,g]),o=new d.Rect(a,b,f,g);m.blit(e,new d.Rect([0,0],[f,g]),o);n.push(m)}this.rect=new d.Rect([0,0],[f,g]);return this}}},["gamejs"]);
require.define({"boids/boid":function(f,b){var d=f("gamejs"),c=f("gamejs/utils/vectors"),k=f("../prng"),g=b.Boid=function(a){this.flock=a.flock;this.pos=a.pos;this.vel=[0,0];this.perceivedVelocity=this.perceivedCenter=this.oldVelocity=null;this.forceUpdateCountDown=g.getUpdateDelta();this.speed=a.speed||25;return this};g.SIZE=18;g.getUpdateDelta=function(){return 50+k.random()*50};g.prototype.update=function(a){this.forceUpdateCountDown-=a;if(this.forceUpdateCountDown<=0){this.forceUpdateCountDown=
g.getUpdateDelta();this.oldVelocity=this.vel.slice(0);var b=this.getMapForce(),b=c.add(b,this.getSeperationForce()),b=c.add(b,this.getAlignmentForce()),b=c.add(b,this.getCohesionForce()),b=c.unit(b);this.vel=c.add(c.divide(b,2),c.divide(this.oldVelocity,2));this.vel=c.unit(this.vel)}this.pos=c.add(this.pos,c.multiply(this.vel,a/1E3*this.speed));return!0};g.prototype.getSeperationForce=function(){var a=[0,0];this.flock.allBoids.forEach(function(b){if(b!=this){var b=c.subtract(b.pos,this.pos),d=c.len(b);
d<g.SIZE*1.5&&d!=0&&(a=c.subtract(a,b))}},this);return c.multiply(a,5)};g.prototype.getAlignmentForce=function(){c.subtract(this.pos,this.flock.center);var a=this.flock.boids.length<2?this.pos:c.divide(c.subtract(this.flock.centerWeight,this.pos),this.flock.boids.length-1);return c.multiply(c.subtract(a,this.pos),0.005)};g.prototype.getCohesionForce=function(){var a=this.flock.boids.length<2?this.vel:c.divide(c.subtract(this.flock.velocityWeight,this.vel),this.flock.boids.length-1),a=c.divide(c.subtract(a,
this.vel),8);return a=c.add(a,c.unit(this.flock.targetVector))};var a=[[0,1],[1,0],[-1,0],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]];a.forEach(function(b){a.push(c.multiply(b,2))});g.prototype.getMapForce=function(){var b=[0,0],d=[this.pos[0]|0,this.pos[1]|0];a.forEach(function(a){this.flock.chunk.isMoveable(c.add(d,a))||(b=c.add(b,c.multiply(a,-1)))},this);return c.multiply(b,400)};g.prototype.draw=function(a){d.draw.circle(a,"#ff0000",this.pos,5)}}},["gamejs","gamejs/utils/vectors","prng"]);
require.define({"boids/flock":function(f,b){var d=f("gamejs"),c=f("gamejs/utils/vectors"),k=f("./boid").Boid,g=b.Flock=function(a){this.boids=[];this.velocityWeight=this.centerWeight=this.center=null;this.target=a.target||[0,0];this.chunk=a.chunk;this.allBoids=g.boids;return this};g.boids=[];g.prototype.createBoid=function(a){a=new k(d.utils.objects.merge(a,{flock:this,pos:[0,0]}));this.boids.push(a);g.boids.push(a);return a};g.prototype.draw=function(a){this.boids.forEach(function(b){b.draw(a)})};
g.prototype.update=function(a){this.boids=this.boids.filter(function(a){if(a.isDead===!0)return d.utils.arrays.remove(a,g.boids),d.utils.arrays.remove(a,this.allBoids),!1;return!0},this);if(!(this.boids.length<=0)){var b=[0,0],f=[0,0];this.boids.forEach(function(a){b=c.add(b,a.pos);f=c.add(f,a.vel)});this.centerWeight=b.slice(0);this.center=c.divide(b,this.boids.length);this.velocityWeight=f;this.targetVector=c.subtract(this.target,this.center);this.boids.forEach(function(b){b.update(a)});return b}}}},
["gamejs","gamejs/utils/vectors","boids/boid"]);
